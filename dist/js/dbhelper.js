class DBHelper{static get DATABASE_URL(){return"http://localhost:1337"}static get offErrorMsg(){return"Network requests have failed, this is expected if offline"}static getServerData(e){return fetch(e).then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()})}static fetchData(e,t,r){const a=`${DBHelper.DATABASE_URL}/${e}/`;DBHelper.getLocalData(t,e).then(t=>{t.length&&r(null,null,t),DBHelper.getServerData(a).then(t=>{DBHelper._updateDB(e,t),r(null,null,t)}).catch(a=>{t.length?r(null,DBHelper.offErrorMsg,t):r(`No ${e} found :(`,null,null)})})}static fetchDataById(e,t,r,a){const n=`${DBHelper.DATABASE_URL}/${e}/${t}`;DBHelper.getLocalData(r,e,t,!1).then(t=>{t&&a(null,null,t),DBHelper.getServerData(n).then(t=>{DBHelper._updateDB(e,t),a(null,null,t)}).catch(r=>{t?a(null,DBHelper.offErrorMsg,t):a(`No ${e} found :(`,null,null)})})}static fetchReviewsByRestaurantId(e,t,r){const a=`${DBHelper.DATABASE_URL}/reviews/?restaurant_id=${e}`;DBHelper.getLocalData(t,"reviews",e,!0,"by-restaurant").then(e=>{e.length&&(e.reverse(),r(null,null,e)),DBHelper.getServerData(a).then(e=>{DBHelper._updateDB("reviews",e),e.reverse(),r(null,null,e)}).catch(t=>{e.length?r(null,DBHelper.offErrorMsg,e):r("No reviews found :(",null,null)})})}static fetchRestaurantByCuisine(e,t,r){DBHelper.fetchData("restaurants",(t,a,n)=>{if(t)r(t,null);else{const t=n.filter(t=>t.cuisine_type==e);r(a,t)}})}static fetchRestaurantByNeighborhood(e,t,r){DBHelper.fetchData("restaurants",t,(t,a,n)=>{if(t)r(t,null);else{const t=n.filter(t=>t.neighborhood==e);r(a,t)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r,a){DBHelper.fetchData("restaurants",r,(r,n,i)=>{if(r)a(r,null);else{let r=i;"all"!=e&&(r=r.filter(t=>t.cuisine_type==e)),"all"!=t&&(r=r.filter(e=>e.neighborhood==t)),a(n,r)}})}static fetchNeighborhoods(e,t){DBHelper.fetchData("restaurants",e,(e,r,a)=>{if(e)t(e,null);else{const e=a.map((e,t)=>a[t].neighborhood),n=e.filter((t,r)=>e.indexOf(t)==r);t(r,n)}})}static fetchCuisines(e,t){DBHelper.fetchData("restaurants",e,(e,r,a)=>{if(e)t(e,null);else{const e=a.map((e,t)=>a[t].cuisine_type),n=e.filter((t,r)=>e.indexOf(t)==r);t(r,n)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static getPhotoDescription(e){return`Photo of ${e.name} in ${e.neighborhood}`}static imageUrlForRestaurant(e,t=!1){return e&&e.photograph?t?`imgs/${e.photograph}-low.jpg`:`imgs/${e.photograph}.jpg`:"imgs/no-pictures.svg"}static imageSRCSetUrlsForRestaurant(e,t){let r=[];return e&&e.photograph&&t.forEach(t=>{r.push(`imgs/${e.photograph}-${t}.jpg ${t}`)}),r.join(", ")}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static openDatabase(){return navigator.serviceWorker?"indexedDB"in window?idb.open("restaurantsData",1,function(e){["restaurants","reviews","newR","newIsFavourite"].forEach(t=>{if(!e.objectStoreNames.contains(t)){let r=e.createObjectStore(t,{autoIncrement:!0,keyPath:"id"});r.createIndex("by-date","createdAt"),"reviews"!==t&&"newIsFavourite"!==t||r.createIndex("by-restaurant","restaurant_id")}})}):null:Promise.resolve()}static _updateDB(e,t,r){return DBHelper.openDatabase().then(function(r){if(!r)return;var a=r.transaction(e,"readwrite").objectStore(e);[].concat(t).forEach(e=>{a.put(e)}),a.index("by-date").openCursor(null,"prev").then(function(e){return e.advance(30)}).then(function e(t){if(t)return t.delete(),t.continue().then(e)})})}static getLocalData(e,t,r,a=!0,n){return"indexedDB"in window?e.then(e=>{isNaN(r)||(r=parseInt(r));const i=e.transaction(t,"readonly").objectStore(t),l=n?i.index(n):i;return a?r?l.getAll(r):l.getAll():l.get(r)}):null}static registerServiceWorker(){var e;navigator.serviceWorker&&(navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&(e.waiting?DBHelper._updateReady(e.waiting):e.installing?DBHelper._trackInstalling(e.installing):e.addEventListener("updatefound",function(){DBHelper._trackInstalling(e.installing)}))}),navigator.serviceWorker.addEventListener("controllerchange",function(){e||(window.location.reload(),e=!0)}))}static _trackInstalling(e){e.addEventListener("statechange",function(){"installed"==e.state&&DBHelper._updateReady(e)})}static _updateReady(e){this._toastsView=new Toast,this._toastsView.create("New version available",null,["refresh","dismiss"]).answer.then(function(t){"refresh"==t&&e.postMessage({action:"skipWaiting"})})}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwib2ZmRXJyb3JNc2ciLCJbb2JqZWN0IE9iamVjdF0iLCJ1cmwiLCJmZXRjaCIsInRoZW4iLCJyZXNwb25zZSIsIm9rIiwiRXJyb3IiLCJzdGF0dXNUZXh0IiwianNvbiIsImRhdGFOYW1lIiwiZGJQcm9taXNlIiwiY2FsbGJhY2siLCJnZXRMb2NhbERhdGEiLCJvZmZsaW5lRGF0YSIsImxlbmd0aCIsImdldFNlcnZlckRhdGEiLCJkYXRhRnJvbU5ldHdvcmsiLCJfdXBkYXRlREIiLCJjYXRjaCIsImVyciIsImlkIiwicmV2ZXJzZSIsImN1aXNpbmUiLCJmZXRjaERhdGEiLCJlcnJvciIsIm1zZyIsInJlc3RhdXJhbnRzIiwicmVzdWx0cyIsImZpbHRlciIsInIiLCJjdWlzaW5lX3R5cGUiLCJuZWlnaGJvcmhvb2QiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJ1bmlxdWVOZWlnaGJvcmhvb2RzIiwiaW5kZXhPZiIsImN1aXNpbmVzIiwidW5pcXVlQ3Vpc2luZXMiLCJyZXN0YXVyYW50IiwibmFtZSIsImxvdyIsInBob3RvZ3JhcGgiLCJvcHRzIiwiaW1hZ2VzIiwiZm9yRWFjaCIsInByb3AiLCJwdXNoIiwiam9pbiIsImdvb2dsZSIsIm1hcHMiLCJNYXJrZXIiLCJwb3NpdGlvbiIsImxhdGxuZyIsInRpdGxlIiwidXJsRm9yUmVzdGF1cmFudCIsImFuaW1hdGlvbiIsIkFuaW1hdGlvbiIsIkRST1AiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwid2luZG93IiwiaWRiIiwib3BlbiIsInVwZ3JhZGVEYiIsIml0ZW0iLCJvYmplY3RTdG9yZU5hbWVzIiwiY29udGFpbnMiLCJzdG9yZSIsImNyZWF0ZU9iamVjdFN0b3JlIiwiYXV0b0luY3JlbWVudCIsImtleVBhdGgiLCJjcmVhdGVJbmRleCIsIlByb21pc2UiLCJyZXNvbHZlIiwiZGF0YSIsIm9wZW5EYXRhYmFzZSIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsImNvbmNhdCIsInB1dCIsImluZGV4Iiwib3BlbkN1cnNvciIsImN1cnNvciIsImFkdmFuY2UiLCJkZWxldGVSZXN0IiwiZGVsZXRlIiwiY29udGludWUiLCJnZXRBbGwiLCJpc05hTiIsInBhcnNlSW50IiwiZGJJbmRleCIsImdldCIsInJlZnJlc2hpbmciLCJyZWdpc3RlciIsInJlZyIsImNvbnRyb2xsZXIiLCJ3YWl0aW5nIiwiX3VwZGF0ZVJlYWR5IiwiaW5zdGFsbGluZyIsIl90cmFja0luc3RhbGxpbmciLCJhZGRFdmVudExpc3RlbmVyIiwibG9jYXRpb24iLCJyZWxvYWQiLCJ3b3JrZXIiLCJzdGF0ZSIsInRoaXMiLCJfdG9hc3RzVmlldyIsIlRvYXN0IiwiY3JlYXRlIiwiYW5zd2VyIiwicG9zdE1lc3NhZ2UiLCJhY3Rpb24iXSwibWFwcGluZ3MiOiJBQUdBLE1BQU1BLFNBTUpDLDBCQUVFLE1BQU8sd0JBR1RDLHlCQUNFLE1BQU8sNERBS1RDLHFCQUFxQkMsR0FDbkIsT0FBT0MsTUFBTUQsR0FBS0UsS0FBS0MsSUFDckIsSUFBS0EsRUFBU0MsR0FDWixNQUFNQyxNQUFNRixFQUFTRyxZQUV2QixPQUFPSCxFQUFTSSxTQVVwQlIsaUJBQWlCUyxFQUFVQyxFQUFXQyxHQUVwQyxNQUFNVixLQUFTSixTQUFTQyxnQkFBZ0JXLEtBRXhDWixTQUFTZSxhQUFhRixFQUFXRCxHQUM5Qk4sS0FBS1UsSUFDQUEsRUFBWUMsUUFDZEgsRUFBUyxLQUFNLEtBQU1FLEdBRXZCaEIsU0FBU2tCLGNBQWNkLEdBQ3BCRSxLQUFLYSxJQUNKbkIsU0FBU29CLFVBQVVSLEVBQVVPLEdBQzdCTCxFQUFTLEtBQU0sS0FBTUssS0FDcEJFLE1BQU1DLElBQ0ZOLEVBQVlDLE9BR2ZILEVBQVMsS0FBTWQsU0FBU0UsWUFBYWMsR0FGckNGLFFBQWVGLGFBQXFCLEtBQU0sVUFXdERULHFCQUFxQlMsRUFBVVcsRUFBSVYsRUFBV0MsR0FDNUMsTUFBTVYs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QyxPQUFPN0csS0FBSyxTQUFTNkcsR0FDWCxXQUFWQSxHQUNKTixFQUFPTyxZQUFZLENBQUNDLE9BQVEiLCJmaWxlIjoiZGJoZWxwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXHJcbiAqL1xyXG5jbGFzcyBEQkhlbHBlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIERhdGFiYXNlIFVSTC5cclxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgc3RhdGljIGdldCBEQVRBQkFTRV9VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWA7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0IG9mZkVycm9yTXNnKCkge1xyXG4gICAgcmV0dXJuICdOZXR3b3JrIHJlcXVlc3RzIGhhdmUgZmFpbGVkLCB0aGlzIGlzIGV4cGVjdGVkIGlmIG9mZmxpbmUnO1xyXG4gIH1cclxuXHJcbiAgLyogTmV0d29yayBmdW5jdGlvbnMgKi9cclxuXHJcbiAgc3RhdGljIGdldFNlcnZlckRhdGEodXJsKSB7XHJcbiAgICByZXR1cm4gZmV0Y2godXJsKS50aGVuKHJlc3BvbnNlID0+IHtcclxuICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xyXG4gICAgICAgIHRocm93IEVycm9yKHJlc3BvbnNlLnN0YXR1c1RleHQpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCByZXF1ZXN0ZWQgZGF0YS5cclxuICAgKiBVc2luZyBGZXRjaCBBUEkuXHJcbiAgICogQHBhcmFtIGRhdGFOYW1lIG5hbWUgb2YgdGhlIHJlcXVlc3RlZCBkYXRhXHJcbiAgICogQHBhcmFtIGNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvblxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaERhdGEoZGF0YU5hbWUsIGRiUHJvbWlzZSwgY2FsbGJhY2spIHtcclxuXHJcbiAgICBjb25zdCB1cmwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9LyR7ZGF0YU5hbWV9L2A7XHJcblxyXG4gICAgREJIZWxwZXIuZ2V0TG9jYWxEYXRhKGRiUHJvbWlzZSwgZGF0YU5hbWUpXHJcbiAgICAgIC50aGVuKG9mZmxpbmVEYXRhID0+IHtcclxuICAgICAgICBpZiAob2ZmbGluZURhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCBudWxsLCBvZmZsaW5lRGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIERCSGVscGVyLmdldFNlcnZlckRhdGEodXJsKVxyXG4gICAgICAgICAgLnRoZW4oZGF0YUZyb21OZXR3b3JrID0+IHtcclxuICAgICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZURCKGRhdGFOYW1lLCBkYXRhRnJvbU5ldHdvcmspO1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBudWxsLCBkYXRhRnJvbU5ldHdvcmspO1xyXG4gICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgaWYgKCFvZmZsaW5lRGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICBjYWxsYmFjayhgTm8gJHtkYXRhTmFtZX0gZm91bmQgOihgLCBudWxsLCBudWxsKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBEQkhlbHBlci5vZmZFcnJvck1zZywgb2ZmbGluZURhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KVxyXG4gICAgICB9KVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYSBkYXRhIGJ5IGl0cyBJRC5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hEYXRhQnlJZChkYXRhTmFtZSwgaWQsIGRiUHJvbWlzZSwgY2FsbGJhY2spIHtcclxuICAgIGNvbnN0IHVybCA9IGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vJHtkYXRhTmFtZX0vJHtpZH1gO1xyXG5cclxuICAgIERCSGVscGVyLmdldExvY2FsRGF0YShkYlByb21pc2UsIGRhdGFOYW1lLCBpZCwgZmFsc2UpXHJcbiAgICAgIC50aGVuKG9mZmxpbmVEYXRhID0+IHtcclxuICAgICAgICBpZiAob2ZmbGluZURhdGEpIHtcclxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bGwsIG9mZmxpbmVEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgREJIZWxwZXIuZ2V0U2VydmVyRGF0YSh1cmwpXHJcbiAgICAgICAgICAudGhlbihkYXRhRnJvbU5ldHdvcmsgPT4ge1xyXG4gICAgICAgICAgICBEQkhlbHBlci5fdXBkYXRlREIoZGF0YU5hbWUsIGRhdGFGcm9tTmV0d29yayk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bGwsIGRhdGFGcm9tTmV0d29yayk7XHJcbiAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIW9mZmxpbmVEYXRhKSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2soYE5vICR7ZGF0YU5hbWV9IGZvdW5kIDooYCwgbnVsbCwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgREJIZWxwZXIub2ZmRXJyb3JNc2csIG9mZmxpbmVEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgfSlcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCByZXF1ZXN0ZWQgZGF0YS5cclxuICAgKiBVc2luZyBGZXRjaCBBUEkuXHJcbiAgICogQHBhcmFtIGlkIHJlc3RhdXJhbnQgaWRcclxuICAgKiBAcGFyYW0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmV2aWV3c0J5UmVzdGF1cmFudElkKGlkLCBkYlByb21pc2UsIGNhbGxiYWNrKSB7XHJcbiAgICBjb25zdCBkYXRhTmFtZSA9ICdyZXZpZXdzJztcclxuICAgIGNvbnN0IHVybCA9IGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vJHtkYXRhTmFtZX0vP3Jlc3RhdXJhbnRfaWQ9JHtpZH1gO1xyXG5cclxuICAgIERCSGVscGVyLmdldExvY2FsRGF0YShkYlByb21pc2UsIGRhdGFOYW1lLCBpZCwgdHJ1ZSwgJ2J5LXJlc3RhdXJhbnQnKVxyXG4gICAgICAudGhlbihvZmZsaW5lRGF0YSA9PiB7XHJcbiAgICAgICAgaWYgKG9mZmxpbmVEYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgb2ZmbGluZURhdGEucmV2ZXJzZSgpO1xyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgbnVsbCwgb2ZmbGluZURhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBEQkhlbHBlci5nZXRTZXJ2ZXJEYXRhKHVybClcclxuICAgICAgICAgIC50aGVuKGRhdGFGcm9tTmV0d29yayA9PiB7XHJcbiAgICAgICAgICAgIERCSGVscGVyLl91cGRhdGVEQihkYXRhTmFtZSwgZGF0YUZyb21OZXR3b3JrKTtcclxuICAgICAgICAgICAgZGF0YUZyb21OZXR3b3JrLnJldmVyc2UoKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgbnVsbCwgZGF0YUZyb21OZXR3b3JrKTtcclxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgIGlmICghb2ZmbGluZURhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2soYE5vICR7ZGF0YU5hbWV9IGZvdW5kIDooYCwgbnVsbCwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgREJIZWxwZXIub2ZmRXJyb3JNc2csIG9mZmxpbmVEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgfSlcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSB0eXBlIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmUoY3Vpc2luZSwgZGJQcm9taXNlLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzICB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZ1xyXG4gICAgREJIZWxwZXIuZmV0Y2hEYXRhKCdyZXN0YXVyYW50cycsIChlcnJvciwgbXNnLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBjdWlzaW5lIHR5cGVcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XHJcbiAgICAgICAgY2FsbGJhY2sobXNnLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIG5laWdoYm9yaG9vZCB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlOZWlnaGJvcmhvb2QobmVpZ2hib3Job29kLCBkYlByb21pc2UsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCBkYlByb21pc2UsIChlcnJvciwgbXNnLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBuZWlnaGJvcmhvb2RcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICBjYWxsYmFjayhtc2csIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSBhbmQgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZChjdWlzaW5lLCBuZWlnaGJvcmhvb2QsIGRiUHJvbWlzZSwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hEYXRhKCdyZXN0YXVyYW50cycsIGRiUHJvbWlzZSwgKGVycm9yLCBtc2csIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgcmVzdWx0cyA9IHJlc3RhdXJhbnRzXHJcbiAgICAgICAgaWYgKGN1aXNpbmUgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IGN1aXNpbmVcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobmVpZ2hib3Job29kICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBuZWlnaGJvcmhvb2RcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhbGxiYWNrKG1zZywgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoTmVpZ2hib3Job29kcyhkYlByb21pc2UsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCBkYlByb21pc2UsIChlcnJvciwgbXNnLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gR2V0IGFsbCBuZWlnaGJvcmhvb2RzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcbiAgICAgICAgY29uc3QgbmVpZ2hib3Job29kcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0ubmVpZ2hib3Job29kKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gbmVpZ2hib3Job29kc1xyXG4gICAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpXHJcbiAgICAgICAgY2FsbGJhY2sobXNnLCB1bmlxdWVOZWlnaGJvcmhvb2RzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgY3Vpc2luZXMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoQ3Vpc2luZXMoZGJQcm9taXNlLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgZGJQcm9taXNlLCAoZXJyb3IsIG1zZywgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgICBjb25zdCBjdWlzaW5lcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0uY3Vpc2luZV90eXBlKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gY3Vpc2luZXNcclxuICAgICAgICBjb25zdCB1bmlxdWVDdWlzaW5lcyA9IGN1aXNpbmVzLmZpbHRlcigodiwgaSkgPT4gY3Vpc2luZXMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKG1zZywgdW5pcXVlQ3Vpc2luZXMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgcGFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIHVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgLi9yZXN0YXVyYW50Lmh0bWw/aWQ9JHtyZXN0YXVyYW50LmlkfWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBkZXNjcmlwdGlvbi5cclxuICAgKi9cclxuICBzdGF0aWMgZ2V0UGhvdG9EZXNjcmlwdGlvbihyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGBQaG90byBvZiAke3Jlc3RhdXJhbnQubmFtZX0gaW4gJHtyZXN0YXVyYW50Lm5laWdoYm9yaG9vZH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbG93ID0gZmFsc2UpIHtcclxuICAgIGlmIChyZXN0YXVyYW50ICYmIHJlc3RhdXJhbnQucGhvdG9ncmFwaCkge1xyXG4gICAgICByZXR1cm4gKGxvdykgPyAoYGltZ3MvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LWxvdy5qcGdgKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgKGBpbWdzLyR7cmVzdGF1cmFudC5waG90b2dyYXBofS5qcGdgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAoYGltZ3Mvbm8tcGljdHVyZXMuc3ZnYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIHNyY3NldCBVUkxzLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVNSQ1NldFVybHNGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG9wdHMpIHtcclxuICAgIGxldCBpbWFnZXMgPSBbXTtcclxuXHJcbiAgICBpZiAocmVzdGF1cmFudCAmJiByZXN0YXVyYW50LnBob3RvZ3JhcGgpIHtcclxuICAgICAgb3B0cy5mb3JFYWNoKHByb3AgPT4ge1xyXG4gICAgICAgIGltYWdlcy5wdXNoKGBpbWdzLyR7cmVzdGF1cmFudC5waG90b2dyYXBofS0ke3Byb3B9LmpwZyAke3Byb3B9YCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpbWFnZXMuam9pbignLCAnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcCBtYXJrZXIgZm9yIGEgcmVzdGF1cmFudC5cclxuICAgKi9cclxuICBzdGF0aWMgbWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBtYXApIHtcclxuICAgIGNvbnN0IG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICBwb3NpdGlvbjogcmVzdGF1cmFudC5sYXRsbmcsXHJcbiAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSxcclxuICAgICAgbWFwOiBtYXAsXHJcbiAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1B9XHJcbiAgICApO1xyXG4gICAgcmV0dXJuIG1hcmtlcjtcclxuICB9XHJcblxyXG4gIC8qIFN0b3JhZ2UgZnVuY3Rpb25zICovXHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZSBkYXRhYmFzZSBmb3IgcmVzdGF1cmFudHMuXHJcbiAgICovXHJcbiAgc3RhdGljIG9wZW5EYXRhYmFzZSgpIHtcclxuICAgIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBzZXJ2aWNlIHdvcmtlcixcclxuICAgIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgaGF2aW5nIGEgZGF0YWJhc2VcclxuICAgIGlmICghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghKCdpbmRleGVkREInIGluIHdpbmRvdykpIHtyZXR1cm4gbnVsbDt9XHJcblxyXG4gICAgcmV0dXJuIGlkYi5vcGVuKCdyZXN0YXVyYW50c0RhdGEnLCAxLCBmdW5jdGlvbih1cGdyYWRlRGIpIHtcclxuICAgICAgY29uc3Qgc3RvcmVzID0gWydyZXN0YXVyYW50cycsICdyZXZpZXdzJywgJ25ld1InLCAnbmV3SXNGYXZvdXJpdGUnXTtcclxuICAgICAgc3RvcmVzLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgaWYgKCF1cGdyYWRlRGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyhpdGVtKSkge1xyXG4gICAgICAgICAgbGV0IHN0b3JlID0gdXBncmFkZURiLmNyZWF0ZU9iamVjdFN0b3JlKGl0ZW0sIHtcclxuICAgICAgICAgICAgYXV0b0luY3JlbWVudCA6IHRydWUsIGtleVBhdGg6ICdpZCdcclxuICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgIHN0b3JlLmNyZWF0ZUluZGV4KCdieS1kYXRlJywgJ2NyZWF0ZWRBdCcpO1xyXG5cclxuICAgICAgICAgIGlmIChpdGVtID09PSAncmV2aWV3cycgfHwgaXRlbSA9PT0gJ25ld0lzRmF2b3VyaXRlJykge1xyXG4gICAgICAgICAgICBzdG9yZS5jcmVhdGVJbmRleCgnYnktcmVzdGF1cmFudCcsICdyZXN0YXVyYW50X2lkJyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGQgbmV3IHJlc3RhdXJhbnRzIGZyb20gbmV0d29yay5cclxuICAgKi9cclxuICBzdGF0aWMgX3VwZGF0ZURCKGRhdGFOYW1lLCBkYXRhLCBjYWxsYmFjaykge1xyXG4gICAgcmV0dXJuIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZnVuY3Rpb24oZGIpIHtcclxuICAgICAgaWYgKCFkYikgcmV0dXJuO1xyXG5cclxuICAgICAgdmFyIHR4ID0gZGIudHJhbnNhY3Rpb24oZGF0YU5hbWUsICdyZWFkd3JpdGUnKTtcclxuICAgICAgdmFyIHN0b3JlID0gdHgub2JqZWN0U3RvcmUoZGF0YU5hbWUpO1xyXG5cclxuICAgICAgbGV0IG5ld0RhdGEgPSBbXS5jb25jYXQoZGF0YSk7XHJcblxyXG4gICAgICBuZXdEYXRhLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgc3RvcmUucHV0KGl0ZW0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIGxpbWl0IHN0b3JlIHRvIDMwIGl0ZW1zXHJcbiAgICAgIHN0b3JlLmluZGV4KCdieS1kYXRlJykub3BlbkN1cnNvcihudWxsLCBcInByZXZcIikudGhlbihmdW5jdGlvbihjdXJzb3IpIHtcclxuICAgICAgICByZXR1cm4gY3Vyc29yLmFkdmFuY2UoMzApO1xyXG4gICAgICB9KS50aGVuKGZ1bmN0aW9uIGRlbGV0ZVJlc3QoY3Vyc29yKSB7XHJcbiAgICAgICAgaWYgKCFjdXJzb3IpIHJldHVybjtcclxuICAgICAgICBjdXJzb3IuZGVsZXRlKCk7XHJcbiAgICAgICAgcmV0dXJuIGN1cnNvci5jb250aW51ZSgpLnRoZW4oZGVsZXRlUmVzdCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0TG9jYWxEYXRhKGRiUHJvbWlzZSwgZGF0YU5hbWUsIGlkLCBnZXRBbGwgPSB0cnVlLCBpbmRleCkge1xyXG4gICAgaWYgKCEoJ2luZGV4ZWREQicgaW4gd2luZG93KSkge3JldHVybiBudWxsO31cclxuICAgIHJldHVybiBkYlByb21pc2UudGhlbihkYiA9PiB7XHJcbiAgICAgIGlmKCFpc05hTihpZCkpIHtcclxuICAgICAgICBpZCA9IHBhcnNlSW50KGlkKTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKGRhdGFOYW1lLCAncmVhZG9ubHknKTtcclxuICAgICAgY29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZShkYXRhTmFtZSk7XHJcbiAgICAgIGNvbnN0IGRiSW5kZXggPSAoaW5kZXgpID8gc3RvcmUuaW5kZXgoaW5kZXgpIDogc3RvcmU7XHJcbiAgICAgIGlmIChnZXRBbGwpIHtcclxuICAgICAgICByZXR1cm4gKGlkKSA/IGRiSW5kZXguZ2V0QWxsKGlkKSA6IGRiSW5kZXguZ2V0QWxsKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIGRiSW5kZXguZ2V0KGlkKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZWdpc3RlciBzZXJ2aWNlIHdvcmtlclxyXG4gICAqL1xyXG4gICBzdGF0aWMgcmVnaXN0ZXJTZXJ2aWNlV29ya2VyKCkge1xyXG4gICAgIGlmICghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuICAgICAgIHJldHVybjtcclxuICAgICB9XHJcblxyXG4gICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLnJlZ2lzdGVyKCdzdy5qcycpLnRoZW4oZnVuY3Rpb24ocmVnKSB7XHJcbiAgICAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmNvbnRyb2xsZXIpIHtcclxuICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgfVxyXG5cclxuICAgICAgIGlmIChyZWcud2FpdGluZykge1xyXG4gICAgICAgICBEQkhlbHBlci5fdXBkYXRlUmVhZHkocmVnLndhaXRpbmcpO1xyXG4gICAgICAgICByZXR1cm47XHJcbiAgICAgICB9XHJcblxyXG4gICAgICAgaWYgKHJlZy5pbnN0YWxsaW5nKSB7XHJcbiAgICAgICAgIERCSGVscGVyLl90cmFja0luc3RhbGxpbmcocmVnLmluc3RhbGxpbmcpO1xyXG4gICAgICAgICByZXR1cm47XHJcbiAgICAgICB9XHJcblxyXG4gICAgICAgcmVnLmFkZEV2ZW50TGlzdGVuZXIoJ3VwZGF0ZWZvdW5kJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgIERCSGVscGVyLl90cmFja0luc3RhbGxpbmcocmVnLmluc3RhbGxpbmcpO1xyXG4gICAgICAgfSk7XHJcbiAgICAgfSk7XHJcblxyXG4gICAgIC8vIEVuc3VyZSByZWZyZXNoIGlzIG9ubHkgY2FsbGVkIG9uY2UuXHJcbiAgICAgLy8gVGhpcyB3b3JrcyBhcm91bmQgYSBidWcgaW4gXCJmb3JjZSB1cGRhdGUgb24gcmVsb2FkXCIuXHJcbiAgICAgdmFyIHJlZnJlc2hpbmc7XHJcbiAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignY29udHJvbGxlcmNoYW5nZScsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgaWYgKHJlZnJlc2hpbmcpIHJldHVybjtcclxuICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcclxuICAgICAgIHJlZnJlc2hpbmcgPSB0cnVlO1xyXG4gICAgIH0pO1xyXG4gICB9XHJcblxyXG4gICAvKipcclxuICAgICogc2VydmljZSB3b3JrZXJcclxuICAgICovXHJcbiAgIHN0YXRpYyBfdHJhY2tJbnN0YWxsaW5nKHdvcmtlcikge1xyXG4gICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgaWYgKHdvcmtlci5zdGF0ZSA9PSAnaW5zdGFsbGVkJykge1xyXG4gICAgICAgICBEQkhlbHBlci5fdXBkYXRlUmVhZHkod29ya2VyKTtcclxuICAgICAgIH1cclxuICAgICB9KTtcclxuICAgfVxyXG5cclxuICAgLyoqXHJcbiAgICAqIHNlcnZpY2Ugd29ya2VyXHJcbiAgICAqL1xyXG4gICBzdGF0aWMgX3VwZGF0ZVJlYWR5KHdvcmtlcikge1xyXG4gICAgIHRoaXMuX3RvYXN0c1ZpZXcgPSBuZXcgVG9hc3QoKTtcclxuICAgICBjb25zdCB0b2FzdCA9IHRoaXMuX3RvYXN0c1ZpZXcuY3JlYXRlKFwiTmV3IHZlcnNpb24gYXZhaWxhYmxlXCIsIG51bGwsIFsncmVmcmVzaCcsICdkaXNtaXNzJ10pO1xyXG5cclxuICAgICB0b2FzdC5hbnN3ZXIudGhlbihmdW5jdGlvbihhbnN3ZXIpIHtcclxuICAgICAgIGlmIChhbnN3ZXIgIT0gJ3JlZnJlc2gnKSByZXR1cm47XHJcbiAgICAgICB3b3JrZXIucG9zdE1lc3NhZ2Uoe2FjdGlvbjogJ3NraXBXYWl0aW5nJ30pO1xyXG4gICAgIH0pO1xyXG4gICB9XHJcblxyXG59XHJcbiJdfQ==
