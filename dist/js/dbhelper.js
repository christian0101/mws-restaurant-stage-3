class DBHelper{static get DATABASE_URL(){return"http://localhost:1337"}static get errorMsg(){return"Oh no! Could not refresh content :("}static fetchData(e,t){DBHelper.openDatabase().then(function(r){if(!r)return;r.transaction(e).objectStore(e).getAll().then(function(r){fetch(`${DBHelper.DATABASE_URL}/${e}/`).then(e=>e.json()).then(n=>{JSON.stringify(n)!==JSON.stringify(r)?(DBHelper._updateDB(e,n),t(null,n)):t(null,r)}).catch(e=>t(DBHelper.errorMsg,r))})})}static fetchDataById(e,t,r){DBHelper.openDatabase().then(function(n){if(!n)return;let a=n.transaction(e).objectStore(e);const i=parseInt(t);a.get(i).then(function(t){fetch(`${DBHelper.DATABASE_URL}/${e}/${i}`).then(e=>e.json()).then(n=>{JSON.stringify(n)!==JSON.stringify(t)?(DBHelper._updateDB(e,n),r(null,n)):r(null,t)}).catch(e=>r(DBHelper.errorMsg,t))})})}static fetchReviewsByRestaurantId(e,t){DBHelper.openDatabase().then(function(r){if(!r)return;let n=r.transaction("reviews").objectStore("reviews");const a=parseInt(e);n.index("by-restaurant").getAll(a).then(function(e){fetch(`${DBHelper.DATABASE_URL}/reviews/?restaurant_id=${a}`).then(e=>e.json()).then(r=>{JSON.stringify(r)!==JSON.stringify(e)?(console.log(r),console.log(e),DBHelper._updateDB("reviews",r),t(null,r)):t(null,e)}).catch(r=>t(DBHelper.errorMsg,e))})})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchData("restaurants",(r,n)=>{if(r&&0===n.length)t(r,null);else{const a=n.filter(t=>t.cuisine_type==e);t(r,a)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchData("restaurants",(r,n)=>{if(r&&0===n.length)t(r,null);else{const a=n.filter(t=>t.neighborhood==e);t(r,a)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchData("restaurants",(n,a)=>{if(n&&0===a.length)r(n,null);else{let i=a;"all"!=e&&(i=i.filter(t=>t.cuisine_type==e)),"all"!=t&&(i=i.filter(e=>e.neighborhood==t)),r(n,i)}})}static fetchNeighborhoods(e){DBHelper.fetchData("restaurants",(t,r)=>{if(t&&0===r.length)e(t,null);else{const n=r.map((e,t)=>r[t].neighborhood),a=n.filter((e,t)=>n.indexOf(e)==t);e(t,a)}})}static fetchCuisines(e){DBHelper.fetchData("restaurants",(t,r)=>{if(t&&0===r.length)e(t,null);else{const n=r.map((e,t)=>r[t].cuisine_type),a=n.filter((e,t)=>n.indexOf(e)==t);e(t,a)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static getPhotoDescription(e){return`Photo of ${e.name} in ${e.neighborhood}`}static imageUrlForRestaurant(e,t=!1){return e&&e.photograph?t?`imgs/${e.photograph}-low.jpg`:`imgs/${e.photograph}.jpg`:"imgs/no-pictures.svg"}static imageSRCSetUrlsForRestaurant(e,t){let r=[];return e&&e.photograph&&t.forEach(t=>{r.push(`imgs/${e.photograph}-${t}.jpg ${t}`)}),r.join(", ")}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static openDatabase(){return navigator.serviceWorker?idb.open("restaurnatsData",1,function(e){["restaurants","reviews"].forEach(t=>{let r=e.createObjectStore(t,{keyPath:"id"});r.createIndex("by-date","createdAt"),"reviews"===t&&r.createIndex("by-restaurant","restaurant_id")})}):Promise.resolve()}static _updateDB(e,t){DBHelper.openDatabase().then(function(r){if(!r)return;var n=r.transaction(e,"readwrite").objectStore(e);[].concat(t).forEach(e=>{n.put(e)}),n.index("by-date").openCursor(null,"prev").then(function(e){return e.advance(30)}).then(function e(t){if(t)return t.delete(),t.continue().then(e)})})}static registerServiceWorker(){var e;navigator.serviceWorker&&(navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&(e.waiting?DBHelper._updateReady(e.waiting):e.installing?DBHelper._trackInstalling(e.installing):e.addEventListener("updatefound",function(){DBHelper._trackInstalling(e.installing)}))}),navigator.serviceWorker.addEventListener("controllerchange",function(){e||(window.location.reload(),e=!0)}))}static _trackInstalling(e){e.addEventListener("statechange",function(){"installed"==e.state&&DBHelper._updateReady(e)})}static _updateReady(e){this._toastsView=new Toast,this._toastsView.create("New version available",{buttons:["refresh","dismiss"]}).answer.then(function(t){"refresh"==t&&e.postMessage({action:"skipWaiting"})})}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwiZXJyb3JNc2ciLCJbb2JqZWN0IE9iamVjdF0iLCJkYXRhTmFtZSIsImNhbGxiYWNrIiwib3BlbkRhdGFiYXNlIiwidGhlbiIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsImdldEFsbCIsImNvbnRlbnQiLCJmZXRjaCIsInJlc3BvbnNlIiwianNvbiIsImRhdGEiLCJKU09OIiwic3RyaW5naWZ5IiwiX3VwZGF0ZURCIiwiY2F0Y2giLCJlIiwiaWQiLCJkYkRhdGEiLCJkYXRhSUQiLCJwYXJzZUludCIsImdldCIsInJlc3RhdXJhbnRJRCIsImluZGV4IiwiY29uc29sZSIsImxvZyIsImN1aXNpbmUiLCJmZXRjaERhdGEiLCJlcnJvciIsInJlc3RhdXJhbnRzIiwibGVuZ3RoIiwicmVzdWx0cyIsImZpbHRlciIsInIiLCJjdWlzaW5lX3R5cGUiLCJuZWlnaGJvcmhvb2QiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJ1bmlxdWVOZWlnaGJvcmhvb2RzIiwiaW5kZXhPZiIsImN1aXNpbmVzIiwidW5pcXVlQ3Vpc2luZXMiLCJyZXN0YXVyYW50IiwibmFtZSIsImxvdyIsInBob3RvZ3JhcGgiLCJvcHRzIiwiaW1hZ2VzIiwiZm9yRWFjaCIsInByb3AiLCJwdXNoIiwiam9pbiIsImdvb2dsZSIsIm1hcHMiLCJNYXJrZXIiLCJwb3NpdGlvbiIsImxhdGxuZyIsInRpdGxlIiwidXJsIiwidXJsRm9yUmVzdGF1cmFudCIsImFuaW1hdGlvbiIsIkFuaW1hdGlvbiIsIkRST1AiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwiaWRiIiwib3BlbiIsInVwZ3JhZGVEYiIsIml0ZW0iLCJzdG9yZSIsImNyZWF0ZU9iamVjdFN0b3JlIiwia2V5UGF0aCIsImNyZWF0ZUluZGV4IiwiUHJvbWlzZSIsInJlc29sdmUiLCJjb25jYXQiLCJwdXQiLCJvcGVuQ3Vyc29yIiwiY3Vyc29yIiwiYWR2YW5jZSIsImRlbGV0ZVJlc3QiLCJkZWxldGUiLCJjb250aW51ZSIsInJlZnJlc2hpbmciLCJyZWdpc3RlciIsInJlZyIsImNvbnRyb2xsZXIiLCJ3YWl0aW5nIiwiX3VwZGF0ZVJlYWR5IiwiaW5zdGFsbGluZyIsIl90cmFja0luc3RhbGxpbmciLCJhZGRFdmVudExpc3RlbmVyIiwid2luZG93IiwibG9jYXRpb24iLCJyZWxvYWQiLCJ3b3JrZXIiLCJzdGF0ZSIsInRoaXMiLCJfdG9hc3RzVmlldyIsIlRvYXN0IiwiY3JlYXRlIiwiYnV0dG9ucyIsImFuc3dlciIsInBvc3RNZXNzYWdlIiwiYWN0aW9uIl0sIm1hcHBpbmdzIjoiQUFHQSxNQUFNQSxTQU1KQywwQkFFRSxNQUFPLHdCQUdUQyxzQkFDRSxNQUFPLHNDQVNUQyxpQkFBaUJDLEVBQVVDLEdBQ3pCTCxTQUFTTSxlQUFlQyxLQUFLLFNBQVNDLEdBQ3BDLElBQUtBLEVBQ0gsT0FHV0EsRUFBR0MsWUFBWUwsR0FBVU0sWUFBWU4sR0FFM0NPLFNBQVNKLEtBQUssU0FBU0ssR0FDNUJDLFNBQVNiLFNBQVNDLGdCQUFnQkcsTUFDakNHLEtBQUtPLEdBQVlBLEVBQVNDLFFBQzFCUixLQUFNUyxJQUVEQyxLQUFLQyxVQUFVRixLQUFVQyxLQUFLQyxVQUFVTixJQUMxQ1osU0FBU21CLFVBQVVmLEVBQVVZLEdBQzdCWCxFQUFTLEtBQU1XLElBRWZYLEVBQVMsS0FBTU8sS0FHbEJRLE1BQU1DLEdBQUtoQixFQUFTTCxTQUFTRSxTQUFVVSxRQVE5Q1QscUJBQXFCQyxFQUFVa0IsRUFBSWpCLEdBQ2pDTCxTQUFTTSxlQUFlQyxLQUFLLFNBQVNDLEdBQ3BDLElBQUtBLEVBQ0gsT0FHRixJQUFJZSxFQUFTZixFQUFHQyxZQUFZTCxHQUFVTSxZQUFZTixHQUNsRCxNQUFNb0IsRUFBU0MsU0FBU0gsR0FFeEJDLEVBQU9HLElBQUlGLEdBQVFqQixLQUFLLFNBQVNLLEdBQy9CQyxTQUFTYixTQUFTQyxnQkFBZ0JHLEtBQVlvQixLQUM3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RixHQUMxQixHQUFLQSxFQUVMLE9BREFBLEVBQU9HLFNBQ0FILEVBQU9JLFdBQVdsRixLQUFLZ0YsT0FRbkNwRiwrQkEyQkUsSUFBSXVGLEVBMUJDcEIsVUFBVUMsZ0JBSWZELFVBQVVDLGNBQWNvQixTQUFTLFNBQVNwRixLQUFLLFNBQVNxRixHQUNqRHRCLFVBQVVDLGNBQWNzQixhQUl6QkQsRUFBSUUsUUFDTjlGLFNBQVMrRixhQUFhSCxFQUFJRSxTQUl4QkYsRUFBSUksV0FDTmhHLFNBQVNpRyxpQkFBaUJMLEVBQUlJLFlBSWhDSixFQUFJTSxpQkFBaUIsY0FBZSxXQUNsQ2xHLFNBQVNpRyxpQkFBaUJMLEVBQUlJLGlCQU9sQzFCLFVBQVVDLGNBQWMyQixpQkFBaUIsbUJBQW9CLFdBQ3ZEUixJQUNKUyxPQUFPQyxTQUFTQyxTQUNoQlgsR0FBYSxNQU9qQnZGLHdCQUF3Qm1HLEdBQ3RCQSxFQUFPSixpQkFBaUIsY0FBZSxXQUNqQixhQUFoQkksRUFBT0MsT0FDVHZHLFNBQVMrRixhQUFhTyxLQVE1Qm5HLG9CQUFvQm1HLEdBQ2xCRSxLQUFLQyxZQUFjLElBQUlDLE1BQ1RGLEtBQUtDLFlBQVlFLE9BQU8sd0JBQXlCLENBQzdEQyxRQUFTLENBQUMsVUFBVyxhQUdqQkMsT0FBT3RHLEtBQUssU0FBU3NHLEdBQ1gsV0FBVkEsR0FDSlAsRUFBT1EsWUFBWSxDQUFDQyxPQUFRIiwiZmlsZSI6ImRiaGVscGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvbW1vbiBkYXRhYmFzZSBoZWxwZXIgZnVuY3Rpb25zLlxyXG4gKi9cclxuY2xhc3MgREJIZWxwZXIge1xyXG5cclxuICAvKipcclxuICAgKiBEYXRhYmFzZSBVUkwuXHJcbiAgICogQ2hhbmdlIHRoaXMgdG8gcmVzdGF1cmFudHMuanNvbiBmaWxlIGxvY2F0aW9uIG9uIHlvdXIgc2VydmVyLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXQgREFUQUJBU0VfVVJMKCkge1xyXG4gICAgY29uc3QgcG9ydCA9IDEzMzcgLy8gQ2hhbmdlIHRoaXMgdG8geW91ciBzZXJ2ZXIgcG9ydFxyXG4gICAgcmV0dXJuIGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH1gO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldCBlcnJvck1zZygpIHtcclxuICAgIHJldHVybiAnT2ggbm8hIENvdWxkIG5vdCByZWZyZXNoIGNvbnRlbnQgOignO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIHJlcXVlc3RlZCBkYXRhLlxyXG4gICAqIFVzaW5nIEZldGNoIEFQSS5cclxuICAgKiBAcGFyYW0gZGF0YU5hbWUgbmFtZSBvZiB0aGUgcmVxdWVzdGVkIGRhdGFcclxuICAgKiBAcGFyYW0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoRGF0YShkYXRhTmFtZSwgY2FsbGJhY2spIHtcclxuICAgIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZnVuY3Rpb24oZGIpIHtcclxuICAgICAgaWYgKCFkYikge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgbGV0IGRiRGF0YSA9IGRiLnRyYW5zYWN0aW9uKGRhdGFOYW1lKS5vYmplY3RTdG9yZShkYXRhTmFtZSk7XHJcblxyXG4gICAgICBkYkRhdGEuZ2V0QWxsKCkudGhlbihmdW5jdGlvbihjb250ZW50KSB7XHJcbiAgICAgICAgZmV0Y2goYCR7REJIZWxwZXIuREFUQUJBU0VfVVJMfS8ke2RhdGFOYW1lfS9gKVxyXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgLy8gdXBkYXRlIElEQiBvbmx5IGlmIGNvbnRlbnQgaXMgZGlmZmVyZW50XHJcbiAgICAgICAgICBpZiAoSlNPTi5zdHJpbmdpZnkoZGF0YSkgIT09IEpTT04uc3RyaW5naWZ5KGNvbnRlbnQpKSB7XHJcbiAgICAgICAgICAgIERCSGVscGVyLl91cGRhdGVEQihkYXRhTmFtZSwgZGF0YSk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgY29udGVudCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZSA9PiBjYWxsYmFjayhEQkhlbHBlci5lcnJvck1zZywgY29udGVudCkpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYSBkYXRhIGJ5IGl0cyBJRC5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hEYXRhQnlJZChkYXRhTmFtZSwgaWQsIGNhbGxiYWNrKSB7XHJcbiAgICBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKS50aGVuKGZ1bmN0aW9uKGRiKSB7XHJcbiAgICAgIGlmICghZGIpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBkYkRhdGEgPSBkYi50cmFuc2FjdGlvbihkYXRhTmFtZSkub2JqZWN0U3RvcmUoZGF0YU5hbWUpO1xyXG4gICAgICBjb25zdCBkYXRhSUQgPSBwYXJzZUludChpZCk7XHJcblxyXG4gICAgICBkYkRhdGEuZ2V0KGRhdGFJRCkudGhlbihmdW5jdGlvbihjb250ZW50KSB7XHJcbiAgICAgICAgZmV0Y2goYCR7REJIZWxwZXIuREFUQUJBU0VfVVJMfS8ke2RhdGFOYW1lfS8ke2RhdGFJRH1gKVxyXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KGRhdGEpICE9PSBKU09OLnN0cmluZ2lmeShjb250ZW50KSkge1xyXG4gICAgICAgICAgICBEQkhlbHBlci5fdXBkYXRlREIoZGF0YU5hbWUsIGRhdGEpO1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGNvbnRlbnQpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZSA9PiBjYWxsYmFjayhEQkhlbHBlci5lcnJvck1zZywgY29udGVudCkpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIHJlcXVlc3RlZCBkYXRhLlxyXG4gICAqIFVzaW5nIEZldGNoIEFQSS5cclxuICAgKiBAcGFyYW0gaWQgcmVzdGF1cmFudCBpZFxyXG4gICAqIEBwYXJhbSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb25cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXZpZXdzQnlSZXN0YXVyYW50SWQoaWQsIGNhbGxiYWNrKSB7XHJcbiAgICBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKS50aGVuKGZ1bmN0aW9uKGRiKSB7XHJcbiAgICAgIGlmICghZGIpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBkYkRhdGEgPSBkYi50cmFuc2FjdGlvbigncmV2aWV3cycpLm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XHJcbiAgICAgIGNvbnN0IHJlc3RhdXJhbnRJRCA9IHBhcnNlSW50KGlkKTtcclxuICAgICAgY29uc3QgcmVzdGF1cmFudFJldmlld3MgPSBkYkRhdGEuaW5kZXgoJ2J5LXJlc3RhdXJhbnQnKTtcclxuXHJcbiAgICAgIHJlc3RhdXJhbnRSZXZpZXdzLmdldEFsbChyZXN0YXVyYW50SUQpLnRoZW4oZnVuY3Rpb24oY29udGVudCkge1xyXG4gICAgICAgIGZldGNoKGAke0RCSGVscGVyLkRBVEFCQVNFX1VSTH0vcmV2aWV3cy8/cmVzdGF1cmFudF9pZD0ke3Jlc3RhdXJhbnRJRH1gKVxyXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KGRhdGEpICE9PSBKU09OLnN0cmluZ2lmeShjb250ZW50KSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coY29udGVudCk7XHJcbiAgICAgICAgICAgIERCSGVscGVyLl91cGRhdGVEQigncmV2aWV3cycsIGRhdGEpO1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGNvbnRlbnQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGUgPT4gY2FsbGJhY2soREJIZWxwZXIuZXJyb3JNc2csIGNvbnRlbnQpKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSB0eXBlIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmUoY3Vpc2luZSwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50cyAgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmdcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvciAmJiByZXN0YXVyYW50cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBjdWlzaW5lIHR5cGVcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeU5laWdoYm9yaG9vZChuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvciAmJiByZXN0YXVyYW50cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBuZWlnaGJvcmhvb2RcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5uZWlnaGJvcmhvb2QgPT0gbmVpZ2hib3Job29kKTtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBjdWlzaW5lIGFuZCBhIG5laWdoYm9yaG9vZCB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lQW5kTmVpZ2hib3Job29kKGN1aXNpbmUsIG5laWdoYm9yaG9vZCwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hEYXRhKCdyZXN0YXVyYW50cycsIChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yICYmIHJlc3RhdXJhbnRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBsZXQgcmVzdWx0cyA9IHJlc3RhdXJhbnRzXHJcbiAgICAgICAgaWYgKGN1aXNpbmUgIT0gJ2FsbCcpIHsgLy8gZmlsdGVyIGJ5IGN1aXNpbmVcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobmVpZ2hib3Job29kICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBuZWlnaGJvcmhvb2RcclxuICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hOZWlnaGJvcmhvb2RzKGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvciAmJiByZXN0YXVyYW50cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gR2V0IGFsbCBuZWlnaGJvcmhvb2RzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcbiAgICAgICAgY29uc3QgbmVpZ2hib3Job29kcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0ubmVpZ2hib3Job29kKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gbmVpZ2hib3Job29kc1xyXG4gICAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpXHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIHVuaXF1ZU5laWdoYm9yaG9vZHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCBjdWlzaW5lcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hDdWlzaW5lcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IgJiYgcmVzdGF1cmFudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgY3Vpc2luZXMgZnJvbSBhbGwgcmVzdGF1cmFudHNcclxuICAgICAgICBjb25zdCBjdWlzaW5lcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0uY3Vpc2luZV90eXBlKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gY3Vpc2luZXNcclxuICAgICAgICBjb25zdCB1bmlxdWVDdWlzaW5lcyA9IGN1aXNpbmVzLmZpbHRlcigodiwgaSkgPT4gY3Vpc2luZXMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCB1bmlxdWVDdWlzaW5lcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBwYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgdXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGAuL3Jlc3RhdXJhbnQuaHRtbD9pZD0ke3Jlc3RhdXJhbnQuaWR9YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIGRlc2NyaXB0aW9uLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXRQaG90b0Rlc2NyaXB0aW9uKHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYFBob3RvIG9mICR7cmVzdGF1cmFudC5uYW1lfSBpbiAke3Jlc3RhdXJhbnQubmVpZ2hib3Job29kfWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIGltYWdlVXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBsb3cgPSBmYWxzZSkge1xyXG4gICAgaWYgKHJlc3RhdXJhbnQgJiYgcmVzdGF1cmFudC5waG90b2dyYXBoKSB7XHJcbiAgICAgIHJldHVybiAobG93KSA/IChgaW1ncy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaH0tbG93LmpwZ2ApIDpcclxuICAgICAgICAgICAgICAgICAgICAoYGltZ3MvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LmpwZ2ApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIChgaW1ncy9uby1waWN0dXJlcy5zdmdgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2Ugc3Jjc2V0IFVSTHMuXHJcbiAgICovXHJcbiAgc3RhdGljIGltYWdlU1JDU2V0VXJsc0ZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgb3B0cykge1xyXG4gICAgbGV0IGltYWdlcyA9IFtdO1xyXG5cclxuICAgIGlmIChyZXN0YXVyYW50ICYmIHJlc3RhdXJhbnQucGhvdG9ncmFwaCkge1xyXG4gICAgICBvcHRzLmZvckVhY2gocHJvcCA9PiB7XHJcbiAgICAgICAgaW1hZ2VzLnB1c2goYGltZ3MvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LSR7cHJvcH0uanBnICR7cHJvcH1gKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGltYWdlcy5qb2luKCcsICcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTWFwIG1hcmtlciBmb3IgYSByZXN0YXVyYW50LlxyXG4gICAqL1xyXG4gIHN0YXRpYyBtYXBNYXJrZXJGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG1hcCkge1xyXG4gICAgY29uc3QgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XHJcbiAgICAgIHBvc2l0aW9uOiByZXN0YXVyYW50LmxhdGxuZyxcclxuICAgICAgdGl0bGU6IHJlc3RhdXJhbnQubmFtZSxcclxuICAgICAgdXJsOiBEQkhlbHBlci51cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpLFxyXG4gICAgICBtYXA6IG1hcCxcclxuICAgICAgYW5pbWF0aW9uOiBnb29nbGUubWFwcy5BbmltYXRpb24uRFJPUH1cclxuICAgICk7XHJcbiAgICByZXR1cm4gbWFya2VyO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIGRhdGFiYXNlIGZvciByZXN0YXVyYW50cy5cclxuICAgKi9cclxuICBzdGF0aWMgb3BlbkRhdGFiYXNlKCkge1xyXG4gICAgLy8gSWYgdGhlIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IHNlcnZpY2Ugd29ya2VyLFxyXG4gICAgLy8gd2UgZG9uJ3QgY2FyZSBhYm91dCBoYXZpbmcgYSBkYXRhYmFzZVxyXG4gICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlcikge1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGlkYi5vcGVuKCdyZXN0YXVybmF0c0RhdGEnLCAxLCBmdW5jdGlvbih1cGdyYWRlRGIpIHtcclxuICAgICAgY29uc3Qgc3RvcmVzID0gWydyZXN0YXVyYW50cycsICdyZXZpZXdzJ107XHJcblxyXG4gICAgICBzdG9yZXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICBsZXQgc3RvcmUgPSB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoaXRlbSwge1xyXG4gICAgICAgICAga2V5UGF0aDogJ2lkJ1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBzdG9yZS5jcmVhdGVJbmRleCgnYnktZGF0ZScsICdjcmVhdGVkQXQnKTtcclxuXHJcbiAgICAgICAgaWYgKGl0ZW0gPT09ICdyZXZpZXdzJykge1xyXG4gICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoJ2J5LXJlc3RhdXJhbnQnLCAncmVzdGF1cmFudF9pZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIG5ldyByZXN0YXVyYW50cyBmcm9tIG5ldHdvcmsuXHJcbiAgICovXHJcbiAgc3RhdGljIF91cGRhdGVEQihkYXRhTmFtZSwgZGF0YSkge1xyXG4gICAgREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihmdW5jdGlvbihkYikge1xyXG4gICAgICBpZiAoIWRiKSByZXR1cm47XHJcblxyXG4gICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbihkYXRhTmFtZSwgJ3JlYWR3cml0ZScpO1xyXG4gICAgICB2YXIgc3RvcmUgPSB0eC5vYmplY3RTdG9yZShkYXRhTmFtZSk7XHJcblxyXG4gICAgICBsZXQgbmV3RGF0YSA9IFtdLmNvbmNhdChkYXRhKTtcclxuXHJcbiAgICAgIG5ld0RhdGEuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICBzdG9yZS5wdXQoaXRlbSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gbGltaXQgc3RvcmUgdG8gMzAgaXRlbXNcclxuICAgICAgc3RvcmUuaW5kZXgoJ2J5LWRhdGUnKS5vcGVuQ3Vyc29yKG51bGwsIFwicHJldlwiKS50aGVuKGZ1bmN0aW9uKGN1cnNvcikge1xyXG4gICAgICAgIHJldHVybiBjdXJzb3IuYWR2YW5jZSgzMCk7XHJcbiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gZGVsZXRlUmVzdChjdXJzb3IpIHtcclxuICAgICAgICBpZiAoIWN1cnNvcikgcmV0dXJuO1xyXG4gICAgICAgIGN1cnNvci5kZWxldGUoKTtcclxuICAgICAgICByZXR1cm4gY3Vyc29yLmNvbnRpbnVlKCkudGhlbihkZWxldGVSZXN0KTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlZ2lzdGVyIHNlcnZpY2Ugd29ya2VyXHJcbiAgICovXHJcbiAgIHN0YXRpYyByZWdpc3RlclNlcnZpY2VXb3JrZXIoKSB7XHJcbiAgICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlcikge1xyXG4gICAgICAgcmV0dXJuO1xyXG4gICAgIH1cclxuXHJcbiAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJ3N3LmpzJykudGhlbihmdW5jdGlvbihyZWcpIHtcclxuICAgICAgIGlmICghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIuY29udHJvbGxlcikge1xyXG4gICAgICAgICByZXR1cm47XHJcbiAgICAgICB9XHJcblxyXG4gICAgICAgaWYgKHJlZy53YWl0aW5nKSB7XHJcbiAgICAgICAgIERCSGVscGVyLl91cGRhdGVSZWFkeShyZWcud2FpdGluZyk7XHJcbiAgICAgICAgIHJldHVybjtcclxuICAgICAgIH1cclxuXHJcbiAgICAgICBpZiAocmVnLmluc3RhbGxpbmcpIHtcclxuICAgICAgICAgREJIZWxwZXIuX3RyYWNrSW5zdGFsbGluZyhyZWcuaW5zdGFsbGluZyk7XHJcbiAgICAgICAgIHJldHVybjtcclxuICAgICAgIH1cclxuXHJcbiAgICAgICByZWcuYWRkRXZlbnRMaXN0ZW5lcigndXBkYXRlZm91bmQnLCBmdW5jdGlvbigpIHtcclxuICAgICAgICAgREJIZWxwZXIuX3RyYWNrSW5zdGFsbGluZyhyZWcuaW5zdGFsbGluZyk7XHJcbiAgICAgICB9KTtcclxuICAgICB9KTtcclxuXHJcbiAgICAgLy8gRW5zdXJlIHJlZnJlc2ggaXMgb25seSBjYWxsZWQgb25jZS5cclxuICAgICAvLyBUaGlzIHdvcmtzIGFyb3VuZCBhIGJ1ZyBpbiBcImZvcmNlIHVwZGF0ZSBvbiByZWxvYWRcIi5cclxuICAgICB2YXIgcmVmcmVzaGluZztcclxuICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdjb250cm9sbGVyY2hhbmdlJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICBpZiAocmVmcmVzaGluZykgcmV0dXJuO1xyXG4gICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xyXG4gICAgICAgcmVmcmVzaGluZyA9IHRydWU7XHJcbiAgICAgfSk7XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICAgKiBzZXJ2aWNlIHdvcmtlclxyXG4gICAgKi9cclxuICAgc3RhdGljIF90cmFja0luc3RhbGxpbmcod29ya2VyKSB7XHJcbiAgICAgd29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ3N0YXRlY2hhbmdlJywgZnVuY3Rpb24oKSB7XHJcbiAgICAgICBpZiAod29ya2VyLnN0YXRlID09ICdpbnN0YWxsZWQnKSB7XHJcbiAgICAgICAgIERCSGVscGVyLl91cGRhdGVSZWFkeSh3b3JrZXIpO1xyXG4gICAgICAgfVxyXG4gICAgIH0pO1xyXG4gICB9XHJcblxyXG4gICAvKipcclxuICAgICogc2VydmljZSB3b3JrZXJcclxuICAgICovXHJcbiAgIHN0YXRpYyBfdXBkYXRlUmVhZHkod29ya2VyKSB7XHJcbiAgICAgdGhpcy5fdG9hc3RzVmlldyA9IG5ldyBUb2FzdCgpO1xyXG4gICAgIGNvbnN0IHRvYXN0ID0gdGhpcy5fdG9hc3RzVmlldy5jcmVhdGUoXCJOZXcgdmVyc2lvbiBhdmFpbGFibGVcIiwge1xyXG4gICAgICAgYnV0dG9uczogWydyZWZyZXNoJywgJ2Rpc21pc3MnXVxyXG4gICAgIH0pO1xyXG5cclxuICAgICB0b2FzdC5hbnN3ZXIudGhlbihmdW5jdGlvbihhbnN3ZXIpIHtcclxuICAgICAgIGlmIChhbnN3ZXIgIT0gJ3JlZnJlc2gnKSByZXR1cm47XHJcbiAgICAgICB3b3JrZXIucG9zdE1lc3NhZ2Uoe2FjdGlvbjogJ3NraXBXYWl0aW5nJ30pO1xyXG4gICAgIH0pO1xyXG4gICB9XHJcbn1cclxuIl19
