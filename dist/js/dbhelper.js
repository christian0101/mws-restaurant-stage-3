class DBHelper{static get DATABASE_URL(){return"http://localhost:1337"}static get errorMsg(){return"Oh no! Could not refresh content :("}static fetchData(e,t){DBHelper.openDatabase().then(function(r){if(!r)return;r.transaction(e).objectStore(e).getAll().then(function(r){fetch(`${DBHelper.DATABASE_URL}/${e}/`).then(e=>e.json()).then(n=>{JSON.stringify(n)!==JSON.stringify(r)?(DBHelper._updateDB(e,n),t(null,n)):t(null,r)}).catch(e=>t(DBHelper.errorMsg,r))})})}static fetchDataById(e,t,r){DBHelper.openDatabase().then(function(n){if(!n)return;n.transaction(e).objectStore(e).get(t).then(function(n){fetch(`${DBHelper.DATABASE_URL}/${e}/${t}`).then(e=>e.json()).then(t=>{JSON.stringify(t)!==JSON.stringify(n)?(DBHelper._updateDB(e,t),r(null,t)):r(null,n)}).catch(e=>r(DBHelper.errorMsg,n))})})}static fetchReviewsByRestaurantId(e,t){DBHelper.openDatabase().then(function(r){if(!r)return;r.transaction("reviews").objectStore("reviews").index("by-restaurant").getAll(e).then(function(r){console.log(r),fetch(`${DBHelper.DATABASE_URL}/reviews/?restaurant_id=${e}`).then(e=>e.json()).then(e=>{JSON.stringify(e)!==JSON.stringify(r)?(DBHelper._updateDB("reviews",e),t(null,e),console.log("data")):t(null,r)}).catch(e=>t(DBHelper.errorMsg,r))})})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchData("restaurants",(r,n)=>{if(r&&0===n.length)t(r,null);else{const a=n.filter(t=>t.cuisine_type==e);t(r,a)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchData("restaurants",(r,n)=>{if(r&&0===n.length)t(r,null);else{const a=n.filter(t=>t.neighborhood==e);t(r,a)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchData("restaurants",(n,a)=>{if(n&&0===a.length)r(n,null);else{let i=a;"all"!=e&&(i=i.filter(t=>t.cuisine_type==e)),"all"!=t&&(i=i.filter(e=>e.neighborhood==t)),r(n,i)}})}static fetchNeighborhoods(e){DBHelper.fetchData("restaurants",(t,r)=>{if(t&&0===r.length)e(t,null);else{const n=r.map((e,t)=>r[t].neighborhood),a=n.filter((e,t)=>n.indexOf(e)==t);e(t,a)}})}static fetchCuisines(e){DBHelper.fetchData("restaurants",(t,r)=>{if(t&&0===r.length)e(t,null);else{const n=r.map((e,t)=>r[t].cuisine_type),a=n.filter((e,t)=>n.indexOf(e)==t);e(t,a)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static getPhotoDescription(e){return`Photo of ${e.name} in ${e.neighborhood}`}static imageUrlForRestaurant(e,t=!1){return e&&e.photograph?t?`imgs/${e.photograph}-low.jpg`:`imgs/${e.photograph}.jpg`:"imgs/no-pictures.svg"}static imageSRCSetUrlsForRestaurant(e,t){let r=[];return e&&e.photograph&&t.forEach(t=>{r.push(`imgs/${e.photograph}-${t}.jpg ${t}`)}),r.join(", ")}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static openDatabase(){return navigator.serviceWorker?idb.open("restaurantsData",1,function(e){["restaurants","reviews","newR","newIsFavourite"].forEach(t=>{let r=e.createObjectStore(t,{autoIncrement:!0,keyPath:"id"});r.createIndex("by-date","createdAt"),"reviews"!==t&&"newIsFavourite"!==t||r.createIndex("by-restaurant","restaurant_id")})}):Promise.resolve()}static _updateDB(e,t,r){return DBHelper.openDatabase().then(function(r){if(!r)return;var n=r.transaction(e,"readwrite").objectStore(e);[].concat(t).forEach(e=>{n.put(e)}),n.index("by-date").openCursor(null,"prev").then(function(e){return e.advance(30)}).then(function e(t){if(t)return t.delete(),t.continue().then(e)})})}static registerServiceWorker(){var e;navigator.serviceWorker&&(navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&(e.waiting?DBHelper._updateReady(e.waiting):e.installing?DBHelper._trackInstalling(e.installing):e.addEventListener("updatefound",function(){DBHelper._trackInstalling(e.installing)}))}),navigator.serviceWorker.addEventListener("controllerchange",function(){e||(window.location.reload(),e=!0)}))}static _trackInstalling(e){e.addEventListener("statechange",function(){"installed"==e.state&&DBHelper._updateReady(e)})}static _updateReady(e){this._toastsView=new Toast,this._toastsView.create("New version available",{buttons:["refresh","dismiss"]}).answer.then(function(t){"refresh"==t&&e.postMessage({action:"skipWaiting"})})}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwiZXJyb3JNc2ciLCJbb2JqZWN0IE9iamVjdF0iLCJkYXRhTmFtZSIsImNhbGxiYWNrIiwib3BlbkRhdGFiYXNlIiwidGhlbiIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsImdldEFsbCIsImNvbnRlbnQiLCJmZXRjaCIsInJlc3BvbnNlIiwianNvbiIsImRhdGEiLCJKU09OIiwic3RyaW5naWZ5IiwiX3VwZGF0ZURCIiwiY2F0Y2giLCJlIiwiaWQiLCJnZXQiLCJpbmRleCIsImNvbnNvbGUiLCJsb2ciLCJjdWlzaW5lIiwiZmV0Y2hEYXRhIiwiZXJyb3IiLCJyZXN0YXVyYW50cyIsImxlbmd0aCIsInJlc3VsdHMiLCJmaWx0ZXIiLCJyIiwiY3Vpc2luZV90eXBlIiwibmVpZ2hib3Job29kIiwibmVpZ2hib3Job29kcyIsIm1hcCIsInYiLCJpIiwidW5pcXVlTmVpZ2hib3Job29kcyIsImluZGV4T2YiLCJjdWlzaW5lcyIsInVuaXF1ZUN1aXNpbmVzIiwicmVzdGF1cmFudCIsIm5hbWUiLCJsb3ciLCJwaG90b2dyYXBoIiwib3B0cyIsImltYWdlcyIsImZvckVhY2giLCJwcm9wIiwicHVzaCIsImpvaW4iLCJnb29nbGUiLCJtYXBzIiwiTWFya2VyIiwicG9zaXRpb24iLCJsYXRsbmciLCJ0aXRsZSIsInVybCIsInVybEZvclJlc3RhdXJhbnQiLCJhbmltYXRpb24iLCJBbmltYXRpb24iLCJEUk9QIiwibmF2aWdhdG9yIiwic2VydmljZVdvcmtlciIsImlkYiIsIm9wZW4iLCJ1cGdyYWRlRGIiLCJpdGVtIiwic3RvcmUiLCJjcmVhdGVPYmplY3RTdG9yZSIsImF1dG9JbmNyZW1lbnQiLCJrZXlQYXRoIiwiY3JlYXRlSW5kZXgiLCJQcm9taXNlIiwicmVzb2x2ZSIsImNvbmNhdCIsInB1dCIsIm9wZW5DdXJzb3IiLCJjdXJzb3IiLCJhZHZhbmNlIiwiZGVsZXRlUmVzdCIsImRlbGV0ZSIsImNvbnRpbnVlIiwicmVmcmVzaGluZyIsInJlZ2lzdGVyIiwicmVnIiwiY29udHJvbGxlciIsIndhaXRpbmciLCJfdXBkYXRlUmVhZHkiLCJpbnN0YWxsaW5nIiwiX3RyYWNrSW5zdGFsbGluZyIsImFkZEV2ZW50TGlzdGVuZXIiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInJlbG9hZCIsIndvcmtlciIsInN0YXRlIiwidGhpcyIsIl90b2FzdHNWaWV3IiwiVG9hc3QiLCJjcmVhdGUiLCJidXR0b25zIiwiYW5zd2VyIiwicG9zdE1lc3NhZ2UiLCJhY3Rpb24iXSwibWFwcGluZ3MiOiJBQUdBLE1BQU1BLFNBTUpDLDBCQUVFLE1BQU8sd0JBR1RDLHNCQUNFLE1BQU8sc0NBU1RDLGlCQUFpQkMsRUFBVUMsR0FDekJMLFNBQVNNLGVBQWVDLEtBQUssU0FBU0MsR0FDcEMsSUFBS0EsRUFDSCxPQUdXQSxFQUFHQyxZQUFZTCxHQUFVTSxZQUFZTixHQUUzQ08sU0FBU0osS0FBSyxTQUFTSyxHQUM1QkMsU0FBU2IsU0FBU0MsZ0JBQWdCRyxNQUNqQ0csS0FBS08sR0FBWUEsRUFBU0MsUUFDMUJSLEtBQU1TLElBRURDLEtBQUtDLFVBQVVGLEtBQVVDLEtBQUtDLFVBQVVOLElBQzFDWixTQUFTbUIsVUFBVWYsRUFBVVksR0FDN0JYLEVBQVMsS0FBTVcsSUFFZlgsRUFBUyxLQUFNTyxLQUdsQlEsTUFBTUMsR0FBS2hCLEVBQVNMLFNBQVNFLFNBQVVVLFFBUTlDVCxxQkFBcUJDLEVBQVVrQixFQUFJakIsR0FDakNMLFNBQVNNLGVBQWVDLEtBQUssU0FBU0MsR0FDcEMsSUFBS0EsRUFDSCxPQUdXQSxFQUFHQyxZQUFZTCxHQUFVTSxZQUFZTixHQUUzQ21CLElBQUlELEdBQUlmLEtBQUssU0FBU0ssR0FDM0JDLFNBQVNiLFNBQVNDLGdCQUFnQkcsS0FBWWtCLEtBQzdDZixLQUFLTyxHQUFZQSxFQUFTQyxRQUMxQlIsS0FBTVMsSUFDREMsS0FBS0MsVUFBVUYsS0FBVUMsS0FBS0MsVUFBVU4s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RSxJQUFJb0YsRUExQkNyQixVQUFVQyxnQkFJZkQsVUFBVUMsY0FBY3FCLFNBQVMsU0FBU2pGLEtBQUssU0FBU2tGLEdBQ2pEdkIsVUFBVUMsY0FBY3VCLGFBSXpCRCxFQUFJRSxRQUNOM0YsU0FBUzRGLGFBQWFILEVBQUlFLFNBSXhCRixFQUFJSSxXQUNON0YsU0FBUzhGLGlCQUFpQkwsRUFBSUksWUFJaENKLEVBQUlNLGlCQUFpQixjQUFlLFdBQ2xDL0YsU0FBUzhGLGlCQUFpQkwsRUFBSUksaUJBT2xDM0IsVUFBVUMsY0FBYzRCLGlCQUFpQixtQkFBb0IsV0FDdkRSLElBQ0pTLE9BQU9DLFNBQVNDLFNBQ2hCWCxHQUFhLE1BT2pCcEYsd0JBQXdCZ0csR0FDdEJBLEVBQU9KLGlCQUFpQixjQUFlLFdBQ2pCLGFBQWhCSSxFQUFPQyxPQUNUcEcsU0FBUzRGLGFBQWFPLEtBUTVCaEcsb0JBQW9CZ0csR0FDbEJFLEtBQUtDLFlBQWMsSUFBSUMsTUFDVEYsS0FBS0MsWUFBWUUsT0FBTyx3QkFBeUIsQ0FDN0RDLFFBQVMsQ0FBQyxVQUFXLGFBR2pCQyxPQUFPbkcsS0FBSyxTQUFTbUcsR0FDWCxXQUFWQSxHQUNKUCxFQUFPUSxZQUFZLENBQUNDLE9BQVEiLCJmaWxlIjoiZGJoZWxwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXHJcbiAqL1xyXG5jbGFzcyBEQkhlbHBlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIERhdGFiYXNlIFVSTC5cclxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgc3RhdGljIGdldCBEQVRBQkFTRV9VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWA7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgZ2V0IGVycm9yTXNnKCkge1xyXG4gICAgcmV0dXJuICdPaCBubyEgQ291bGQgbm90IHJlZnJlc2ggY29udGVudCA6KCc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgcmVxdWVzdGVkIGRhdGEuXHJcbiAgICogVXNpbmcgRmV0Y2ggQVBJLlxyXG4gICAqIEBwYXJhbSBkYXRhTmFtZSBuYW1lIG9mIHRoZSByZXF1ZXN0ZWQgZGF0YVxyXG4gICAqIEBwYXJhbSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb25cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hEYXRhKGRhdGFOYW1lLCBjYWxsYmFjaykge1xyXG4gICAgREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihmdW5jdGlvbihkYikge1xyXG4gICAgICBpZiAoIWRiKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgZGJEYXRhID0gZGIudHJhbnNhY3Rpb24oZGF0YU5hbWUpLm9iamVjdFN0b3JlKGRhdGFOYW1lKTtcclxuXHJcbiAgICAgIGRiRGF0YS5nZXRBbGwoKS50aGVuKGZ1bmN0aW9uKGNvbnRlbnQpIHtcclxuICAgICAgICBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9LyR7ZGF0YU5hbWV9L2ApXHJcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UuanNvbigpKVxyXG4gICAgICAgIC50aGVuKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAvLyB1cGRhdGUgSURCIG9ubHkgaWYgY29udGVudCBpcyBkaWZmZXJlbnRcclxuICAgICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShkYXRhKSAhPT0gSlNPTi5zdHJpbmdpZnkoY29udGVudCkpIHtcclxuICAgICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZURCKGRhdGFOYW1lLCBkYXRhKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBjb250ZW50KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaChlID0+IGNhbGxiYWNrKERCSGVscGVyLmVycm9yTXNnLCBjb250ZW50KSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhIGRhdGEgYnkgaXRzIElELlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaERhdGFCeUlkKGRhdGFOYW1lLCBpZCwgY2FsbGJhY2spIHtcclxuICAgIERCSGVscGVyLm9wZW5EYXRhYmFzZSgpLnRoZW4oZnVuY3Rpb24oZGIpIHtcclxuICAgICAgaWYgKCFkYikge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgbGV0IGRiRGF0YSA9IGRiLnRyYW5zYWN0aW9uKGRhdGFOYW1lKS5vYmplY3RTdG9yZShkYXRhTmFtZSk7XHJcblxyXG4gICAgICBkYkRhdGEuZ2V0KGlkKS50aGVuKGZ1bmN0aW9uKGNvbnRlbnQpIHtcclxuICAgICAgICBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9LyR7ZGF0YU5hbWV9LyR7aWR9YClcclxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZS5qc29uKCkpXHJcbiAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcclxuICAgICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShkYXRhKSAhPT0gSlNPTi5zdHJpbmdpZnkoY29udGVudCkpIHtcclxuICAgICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZURCKGRhdGFOYW1lLCBkYXRhKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBjb250ZW50KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKGUgPT4gY2FsbGJhY2soREJIZWxwZXIuZXJyb3JNc2csIGNvbnRlbnQpKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCByZXF1ZXN0ZWQgZGF0YS5cclxuICAgKiBVc2luZyBGZXRjaCBBUEkuXHJcbiAgICogQHBhcmFtIGlkIHJlc3RhdXJhbnQgaWRcclxuICAgKiBAcGFyYW0gY2FsbGJhY2sgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmV2aWV3c0J5UmVzdGF1cmFudElkKGlkLCBjYWxsYmFjaykge1xyXG4gICAgREJIZWxwZXIub3BlbkRhdGFiYXNlKCkudGhlbihmdW5jdGlvbihkYikge1xyXG4gICAgICBpZiAoIWRiKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgZGJEYXRhID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlld3MnKS5vYmplY3RTdG9yZSgncmV2aWV3cycpO1xyXG4gICAgICBjb25zdCByZXN0YXVyYW50UmV2aWV3cyA9IGRiRGF0YS5pbmRleCgnYnktcmVzdGF1cmFudCcpO1xyXG5cclxuICAgICAgcmVzdGF1cmFudFJldmlld3MuZ2V0QWxsKGlkKS50aGVuKGZ1bmN0aW9uKGNvbnRlbnQpIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhjb250ZW50KTtcclxuICAgICAgICBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9L3Jldmlld3MvP3Jlc3RhdXJhbnRfaWQ9JHtpZH1gKVxyXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xyXG4gICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KGRhdGEpICE9PSBKU09OLnN0cmluZ2lmeShjb250ZW50KSkge1xyXG4gICAgICAgICAgICBEQkhlbHBlci5fdXBkYXRlREIoJ3Jldmlld3MnLCBkYXRhKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgZGF0YSk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdkYXRhJyk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBjb250ZW50KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIC5jYXRjaChlID0+IGNhbGxiYWNrKERCSGVscGVyLmVycm9yTXNnLCBjb250ZW50KSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHMgIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IgJiYgcmVzdGF1cmFudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gY3Vpc2luZSB0eXBlXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIG5laWdoYm9yaG9vZCB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlOZWlnaGJvcmhvb2QobmVpZ2hib3Job29kLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IgJiYgcmVzdGF1cmFudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gbmVpZ2hib3Job29kXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSBhbmQgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZChjdWlzaW5lLCBuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCAoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvciAmJiByZXN0YXVyYW50cy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbGV0IHJlc3VsdHMgPSByZXN0YXVyYW50c1xyXG4gICAgICAgIGlmIChjdWlzaW5lICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBjdWlzaW5lXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5laWdoYm9yaG9vZCAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgbmVpZ2hib3Job29kXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIG5laWdoYm9yaG9vZHMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoTmVpZ2hib3Job29kcyhjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IgJiYgcmVzdGF1cmFudHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgbmVpZ2hib3Job29kcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZClcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcclxuICAgICAgICBjb25zdCB1bmlxdWVOZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcy5maWx0ZXIoKHYsIGkpID0+IG5laWdoYm9yaG9vZHMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCB1bmlxdWVOZWlnaGJvcmhvb2RzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgY3Vpc2luZXMgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoQ3Vpc2luZXMoY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hEYXRhKCdyZXN0YXVyYW50cycsIChlcnJvciwgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yICYmIHJlc3RhdXJhbnRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBHZXQgYWxsIGN1aXNpbmVzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcbiAgICAgICAgY29uc3QgY3Vpc2luZXMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLmN1aXNpbmVfdHlwZSlcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIGN1aXNpbmVzXHJcbiAgICAgICAgY29uc3QgdW5pcXVlQ3Vpc2luZXMgPSBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSlcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgdW5pcXVlQ3Vpc2luZXMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgcGFnZSBVUkwuXHJcbiAgICovXHJcbiAgc3RhdGljIHVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgLi9yZXN0YXVyYW50Lmh0bWw/aWQ9JHtyZXN0YXVyYW50LmlkfWApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBkZXNjcmlwdGlvbi5cclxuICAgKi9cclxuICBzdGF0aWMgZ2V0UGhvdG9EZXNjcmlwdGlvbihyZXN0YXVyYW50KSB7XHJcbiAgICByZXR1cm4gKGBQaG90byBvZiAke3Jlc3RhdXJhbnQubmFtZX0gaW4gJHtyZXN0YXVyYW50Lm5laWdoYm9yaG9vZH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbG93ID0gZmFsc2UpIHtcclxuICAgIGlmIChyZXN0YXVyYW50ICYmIHJlc3RhdXJhbnQucGhvdG9ncmFwaCkge1xyXG4gICAgICByZXR1cm4gKGxvdykgPyAoYGltZ3MvJHtyZXN0YXVyYW50LnBob3RvZ3JhcGh9LWxvdy5qcGdgKSA6XHJcbiAgICAgICAgICAgICAgICAgICAgKGBpbWdzLyR7cmVzdGF1cmFudC5waG90b2dyYXBofS5qcGdgKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAoYGltZ3Mvbm8tcGljdHVyZXMuc3ZnYCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIHNyY3NldCBVUkxzLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVNSQ1NldFVybHNGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIG9wdHMpIHtcclxuICAgIGxldCBpbWFnZXMgPSBbXTtcclxuXHJcbiAgICBpZiAocmVzdGF1cmFudCAmJiByZXN0YXVyYW50LnBob3RvZ3JhcGgpIHtcclxuICAgICAgb3B0cy5mb3JFYWNoKHByb3AgPT4ge1xyXG4gICAgICAgIGltYWdlcy5wdXNoKGBpbWdzLyR7cmVzdGF1cmFudC5waG90b2dyYXBofS0ke3Byb3B9LmpwZyAke3Byb3B9YCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpbWFnZXMuam9pbignLCAnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcCBtYXJrZXIgZm9yIGEgcmVzdGF1cmFudC5cclxuICAgKi9cclxuICBzdGF0aWMgbWFwTWFya2VyRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBtYXApIHtcclxuICAgIGNvbnN0IG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xyXG4gICAgICBwb3NpdGlvbjogcmVzdGF1cmFudC5sYXRsbmcsXHJcbiAgICAgIHRpdGxlOiByZXN0YXVyYW50Lm5hbWUsXHJcbiAgICAgIHVybDogREJIZWxwZXIudXJsRm9yUmVzdGF1cmFudChyZXN0YXVyYW50KSxcclxuICAgICAgbWFwOiBtYXAsXHJcbiAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1B9XHJcbiAgICApO1xyXG4gICAgcmV0dXJuIG1hcmtlcjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZSBkYXRhYmFzZSBmb3IgcmVzdGF1cmFudHMuXHJcbiAgICovXHJcbiAgc3RhdGljIG9wZW5EYXRhYmFzZSgpIHtcclxuICAgIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCBzZXJ2aWNlIHdvcmtlcixcclxuICAgIC8vIHdlIGRvbid0IGNhcmUgYWJvdXQgaGF2aW5nIGEgZGF0YWJhc2VcclxuICAgIGlmICghbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIpIHtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpZGIub3BlbigncmVzdGF1cmFudHNEYXRhJywgMSwgZnVuY3Rpb24odXBncmFkZURiKSB7XHJcbiAgICAgIGNvbnN0IHN0b3JlcyA9IFsncmVzdGF1cmFudHMnLCAncmV2aWV3cycsICduZXdSJywgJ25ld0lzRmF2b3VyaXRlJ107XHJcblxyXG4gICAgICBzdG9yZXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICBsZXQgc3RvcmUgPSB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoaXRlbSwge1xyXG4gICAgICAgICAgYXV0b0luY3JlbWVudCA6IHRydWUsIGtleVBhdGg6ICdpZCdcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoJ2J5LWRhdGUnLCAnY3JlYXRlZEF0Jyk7XHJcblxyXG4gICAgICAgIGlmIChpdGVtID09PSAncmV2aWV3cycgfHwgaXRlbSA9PT0gJ25ld0lzRmF2b3VyaXRlJykge1xyXG4gICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoJ2J5LXJlc3RhdXJhbnQnLCAncmVzdGF1cmFudF9pZCcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIG5ldyByZXN0YXVyYW50cyBmcm9tIG5ldHdvcmsuXHJcbiAgICovXHJcbiAgc3RhdGljIF91cGRhdGVEQihkYXRhTmFtZSwgZGF0YSwgY2FsbGJhY2spIHtcclxuICAgIHJldHVybiBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKS50aGVuKGZ1bmN0aW9uKGRiKSB7XHJcbiAgICAgIGlmICghZGIpIHJldHVybjtcclxuXHJcbiAgICAgIHZhciB0eCA9IGRiLnRyYW5zYWN0aW9uKGRhdGFOYW1lLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgIHZhciBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKGRhdGFOYW1lKTtcclxuXHJcbiAgICAgIGxldCBuZXdEYXRhID0gW10uY29uY2F0KGRhdGEpO1xyXG5cclxuICAgICAgbmV3RGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIHN0b3JlLnB1dChpdGVtKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBsaW1pdCBzdG9yZSB0byAzMCBpdGVtc1xyXG4gICAgICBzdG9yZS5pbmRleCgnYnktZGF0ZScpLm9wZW5DdXJzb3IobnVsbCwgXCJwcmV2XCIpLnRoZW4oZnVuY3Rpb24oY3Vyc29yKSB7XHJcbiAgICAgICAgcmV0dXJuIGN1cnNvci5hZHZhbmNlKDMwKTtcclxuICAgICAgfSkudGhlbihmdW5jdGlvbiBkZWxldGVSZXN0KGN1cnNvcikge1xyXG4gICAgICAgIGlmICghY3Vyc29yKSByZXR1cm47XHJcbiAgICAgICAgY3Vyc29yLmRlbGV0ZSgpO1xyXG4gICAgICAgIHJldHVybiBjdXJzb3IuY29udGludWUoKS50aGVuKGRlbGV0ZVJlc3QpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVnaXN0ZXIgc2VydmljZSB3b3JrZXJcclxuICAgKi9cclxuICAgc3RhdGljIHJlZ2lzdGVyU2VydmljZVdvcmtlcigpIHtcclxuICAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSB7XHJcbiAgICAgICByZXR1cm47XHJcbiAgICAgfVxyXG5cclxuICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3Rlcignc3cuanMnKS50aGVuKGZ1bmN0aW9uKHJlZykge1xyXG4gICAgICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyKSB7XHJcbiAgICAgICAgIHJldHVybjtcclxuICAgICAgIH1cclxuXHJcbiAgICAgICBpZiAocmVnLndhaXRpbmcpIHtcclxuICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZVJlYWR5KHJlZy53YWl0aW5nKTtcclxuICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgfVxyXG5cclxuICAgICAgIGlmIChyZWcuaW5zdGFsbGluZykge1xyXG4gICAgICAgICBEQkhlbHBlci5fdHJhY2tJbnN0YWxsaW5nKHJlZy5pbnN0YWxsaW5nKTtcclxuICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgfVxyXG5cclxuICAgICAgIHJlZy5hZGRFdmVudExpc3RlbmVyKCd1cGRhdGVmb3VuZCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICBEQkhlbHBlci5fdHJhY2tJbnN0YWxsaW5nKHJlZy5pbnN0YWxsaW5nKTtcclxuICAgICAgIH0pO1xyXG4gICAgIH0pO1xyXG5cclxuICAgICAvLyBFbnN1cmUgcmVmcmVzaCBpcyBvbmx5IGNhbGxlZCBvbmNlLlxyXG4gICAgIC8vIFRoaXMgd29ya3MgYXJvdW5kIGEgYnVnIGluIFwiZm9yY2UgdXBkYXRlIG9uIHJlbG9hZFwiLlxyXG4gICAgIHZhciByZWZyZXNoaW5nO1xyXG4gICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRyb2xsZXJjaGFuZ2UnLCBmdW5jdGlvbigpIHtcclxuICAgICAgIGlmIChyZWZyZXNoaW5nKSByZXR1cm47XHJcbiAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICByZWZyZXNoaW5nID0gdHJ1ZTtcclxuICAgICB9KTtcclxuICAgfVxyXG5cclxuICAgLyoqXHJcbiAgICAqIHNlcnZpY2Ugd29ya2VyXHJcbiAgICAqL1xyXG4gICBzdGF0aWMgX3RyYWNrSW5zdGFsbGluZyh3b3JrZXIpIHtcclxuICAgICB3b3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignc3RhdGVjaGFuZ2UnLCBmdW5jdGlvbigpIHtcclxuICAgICAgIGlmICh3b3JrZXIuc3RhdGUgPT0gJ2luc3RhbGxlZCcpIHtcclxuICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZVJlYWR5KHdvcmtlcik7XHJcbiAgICAgICB9XHJcbiAgICAgfSk7XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICAgKiBzZXJ2aWNlIHdvcmtlclxyXG4gICAgKi9cclxuICAgc3RhdGljIF91cGRhdGVSZWFkeSh3b3JrZXIpIHtcclxuICAgICB0aGlzLl90b2FzdHNWaWV3ID0gbmV3IFRvYXN0KCk7XHJcbiAgICAgY29uc3QgdG9hc3QgPSB0aGlzLl90b2FzdHNWaWV3LmNyZWF0ZShcIk5ldyB2ZXJzaW9uIGF2YWlsYWJsZVwiLCB7XHJcbiAgICAgICBidXR0b25zOiBbJ3JlZnJlc2gnLCAnZGlzbWlzcyddXHJcbiAgICAgfSk7XHJcblxyXG4gICAgIHRvYXN0LmFuc3dlci50aGVuKGZ1bmN0aW9uKGFuc3dlcikge1xyXG4gICAgICAgaWYgKGFuc3dlciAhPSAncmVmcmVzaCcpIHJldHVybjtcclxuICAgICAgIHdvcmtlci5wb3N0TWVzc2FnZSh7YWN0aW9uOiAnc2tpcFdhaXRpbmcnfSk7XHJcbiAgICAgfSk7XHJcbiAgIH1cclxuXHJcbn1cclxuIl19
