class DBHelper{static get DATABASE_URL(){return"https://api-restaurant-reviews.herokuapp.com"}static get offErrorMsg(){return"Network requests have failed, this is expected if offline"}static getServerData(e){return fetch(e).then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()})}static fetchData(e,t,r){const a=`${DBHelper.DATABASE_URL}/${e}/`;DBHelper.getLocalData(t,e).then(t=>{t.length&&r(null,null,t),DBHelper.getServerData(a).then(t=>{DBHelper._updateDB(e,t),r(null,null,t)}).catch(a=>{t.length?r(null,DBHelper.offErrorMsg,t):r(`No ${e} found :(`,null,null)})})}static fetchDataById(e,t,r,a){const n=`${DBHelper.DATABASE_URL}/${e}/${t}`;DBHelper.getLocalData(r,e,t,!1).then(t=>{t&&a(null,null,t),DBHelper.getServerData(n).then(t=>{DBHelper._updateDB(e,t),a(null,null,t)}).catch(r=>{t?a(null,DBHelper.offErrorMsg,t):a(`No ${e} found :(`,null,null)})})}static fetchReviewsByRestaurantId(e,t,r){const a=`${DBHelper.DATABASE_URL}/reviews/?restaurant_id=${e}`;DBHelper.getLocalData(t,"reviews",e,!0,"by-restaurant").then(e=>{e.length&&(e.reverse(),r(null,null,e)),DBHelper.getServerData(a).then(e=>{DBHelper._updateDB("reviews",e),e.reverse(),r(null,null,e)}).catch(t=>{e.length?r(null,DBHelper.offErrorMsg,e):r("No reviews found :(",null,null)})})}static fetchRestaurantByCuisine(e,t,r){DBHelper.fetchData("restaurants",(t,a,n)=>{if(t)r(t,null);else{const t=n.filter(t=>t.cuisine_type==e);r(a,t)}})}static fetchRestaurantByNeighborhood(e,t,r){DBHelper.fetchData("restaurants",t,(t,a,n)=>{if(t)r(t,null);else{const t=n.filter(t=>t.neighborhood==e);r(a,t)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r,a){DBHelper.fetchData("restaurants",r,(r,n,i)=>{if(r)a(r,null);else{let r=i;"all"!=e&&(r=r.filter(t=>t.cuisine_type==e)),"all"!=t&&(r=r.filter(e=>e.neighborhood==t)),a(n,r)}})}static fetchNeighborhoods(e,t){DBHelper.fetchData("restaurants",e,(e,r,a)=>{if(e)t(e,null);else{const e=a.map((e,t)=>a[t].neighborhood),n=e.filter((t,r)=>e.indexOf(t)==r);t(r,n)}})}static fetchCuisines(e,t){DBHelper.fetchData("restaurants",e,(e,r,a)=>{if(e)t(e,null);else{const e=a.map((e,t)=>a[t].cuisine_type),n=e.filter((t,r)=>e.indexOf(t)==r);t(r,n)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static getPhotoDescription(e){return`Photo of ${e.name} in ${e.neighborhood}`}static imageUrlForRestaurant(e,t=!1){return e&&e.photograph?t?`imgs/${e.photograph}-low.jpg`:`imgs/${e.photograph}.jpg`:"imgs/no-pictures.svg"}static imageSRCSetUrlsForRestaurant(e,t){let r=[];return e&&e.photograph&&t.forEach(t=>{r.push(`imgs/${e.photograph}-${t}.jpg ${t}`)}),r.join(", ")}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static openDatabase(){return navigator.serviceWorker?"indexedDB"in window?idb.open("restaurantsData",1,function(e){["restaurants","reviews","newR","newIsFavourite"].forEach(t=>{if(!e.objectStoreNames.contains(t)){let r=e.createObjectStore(t,{autoIncrement:!0,keyPath:"id"});r.createIndex("by-date","createdAt"),"reviews"!==t&&"newIsFavourite"!==t||r.createIndex("by-restaurant","restaurant_id")}})}):null:Promise.resolve()}static _updateDB(e,t,r){return DBHelper.openDatabase().then(function(r){if(!r)return;var a=r.transaction(e,"readwrite").objectStore(e);[].concat(t).forEach(e=>{a.put(e)}),a.index("by-date").openCursor(null,"prev").then(function(e){return e.advance(30)}).then(function e(t){if(t)return t.delete(),t.continue().then(e)})})}static getLocalData(e,t,r,a=!0,n){return"indexedDB"in window?e.then(e=>{isNaN(r)||(r=parseInt(r));const i=e.transaction(t,"readonly").objectStore(t),s=n?i.index(n):i;return a?r?s.getAll(r):s.getAll():s.get(r)}):null}static registerServiceWorker(){var e;navigator.serviceWorker&&(navigator.serviceWorker.register("sw.js").then(function(e){navigator.serviceWorker.controller&&(e.waiting?DBHelper._updateReady(e.waiting):e.installing?DBHelper._trackInstalling(e.installing):e.addEventListener("updatefound",function(){DBHelper._trackInstalling(e.installing)}))}),navigator.serviceWorker.addEventListener("controllerchange",function(){e||(window.location.reload(),e=!0)}))}static _trackInstalling(e){e.addEventListener("statechange",function(){"installed"==e.state&&DBHelper._updateReady(e)})}static _updateReady(e){this._toastsView=new Toast,this._toastsView.create("New version available",null,["refresh","dismiss"]).answer.then(function(t){"refresh"==t&&e.postMessage({action:"skipWaiting"})})}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwib2ZmRXJyb3JNc2ciLCJbb2JqZWN0IE9iamVjdF0iLCJ1cmwiLCJmZXRjaCIsInRoZW4iLCJyZXNwb25zZSIsIm9rIiwiRXJyb3IiLCJzdGF0dXNUZXh0IiwianNvbiIsImRhdGFOYW1lIiwiZGJQcm9taXNlIiwiY2FsbGJhY2siLCJnZXRMb2NhbERhdGEiLCJvZmZsaW5lRGF0YSIsImxlbmd0aCIsImdldFNlcnZlckRhdGEiLCJkYXRhRnJvbU5ldHdvcmsiLCJfdXBkYXRlREIiLCJjYXRjaCIsImVyciIsImlkIiwicmV2ZXJzZSIsImN1aXNpbmUiLCJmZXRjaERhdGEiLCJlcnJvciIsIm1zZyIsInJlc3RhdXJhbnRzIiwicmVzdWx0cyIsImZpbHRlciIsInIiLCJjdWlzaW5lX3R5cGUiLCJuZWlnaGJvcmhvb2QiLCJuZWlnaGJvcmhvb2RzIiwibWFwIiwidiIsImkiLCJ1bmlxdWVOZWlnaGJvcmhvb2RzIiwiaW5kZXhPZiIsImN1aXNpbmVzIiwidW5pcXVlQ3Vpc2luZXMiLCJyZXN0YXVyYW50IiwibmFtZSIsImxvdyIsInBob3RvZ3JhcGgiLCJvcHRzIiwiaW1hZ2VzIiwiZm9yRWFjaCIsInByb3AiLCJwdXNoIiwiam9pbiIsImdvb2dsZSIsIm1hcHMiLCJNYXJrZXIiLCJwb3NpdGlvbiIsImxhdGxuZyIsInRpdGxlIiwidXJsRm9yUmVzdGF1cmFudCIsImFuaW1hdGlvbiIsIkFuaW1hdGlvbiIsIkRST1AiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwid2luZG93IiwiaWRiIiwib3BlbiIsInVwZ3JhZGVEYiIsIml0ZW0iLCJvYmplY3RTdG9yZU5hbWVzIiwiY29udGFpbnMiLCJzdG9yZSIsImNyZWF0ZU9iamVjdFN0b3JlIiwiYXV0b0luY3JlbWVudCIsImtleVBhdGgiLCJjcmVhdGVJbmRleCIsIlByb21pc2UiLCJyZXNvbHZlIiwiZGF0YSIsIm9wZW5EYXRhYmFzZSIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsImNvbmNhdCIsInB1dCIsImluZGV4Iiwib3BlbkN1cnNvciIsImN1cnNvciIsImFkdmFuY2UiLCJkZWxldGVSZXN0IiwiZGVsZXRlIiwiY29udGludWUiLCJnZXRBbGwiLCJpc05hTiIsInBhcnNlSW50IiwiZGJJbmRleCIsImdldCIsInJlZnJlc2hpbmciLCJyZWdpc3RlciIsInJlZyIsImNvbnRyb2xsZXIiLCJ3YWl0aW5nIiwiX3VwZGF0ZVJlYWR5IiwiaW5zdGFsbGluZyIsIl90cmFja0luc3RhbGxpbmciLCJhZGRFdmVudExpc3RlbmVyIiwibG9jYXRpb24iLCJyZWxvYWQiLCJ3b3JrZXIiLCJzdGF0ZSIsInRoaXMiLCJfdG9hc3RzVmlldyIsIlRvYXN0IiwiY3JlYXRlIiwiYW5zd2VyIiwicG9zdE1lc3NhZ2UiLCJhY3Rpb24iXSwibWFwcGluZ3MiOiJBQUdBLE1BQU1BLFNBTUpDLDBCQUVFLE1BQU8sK0NBR1RDLHlCQUNFLE1BQU8sNERBS1RDLHFCQUFxQkMsR0FDbkIsT0FBT0MsTUFBTUQsR0FBS0UsS0FBS0MsSUFDckIsSUFBS0EsRUFBU0MsR0FDWixNQUFNQyxNQUFNRixFQUFTRyxZQUV2QixPQUFPSCxFQUFTSSxTQVVwQlIsaUJBQWlCUyxFQUFVQyxFQUFXQyxHQUVwQyxNQUFNVixLQUFTSixTQUFTQyxnQkFBZ0JXLEtBRXhDWixTQUFTZSxhQUFhRixFQUFXRCxHQUM5Qk4sS0FBS1UsSUFDQUEsRUFBWUMsUUFDZEgsRUFBUyxLQUFNLEtBQU1FLEdBRXZCaEIsU0FBU2tCLGNBQWNkLEdBQ3BCRSxLQUFLYSxJQUNKbkIsU0FBU29CLFVBQVVSLEVBQVVPLEdBQzdCTCxFQUFTLEtBQU0sS0FBTUssS0FDcEJFLE1BQU1DLElBQ0ZOLEVBQVlDLE9BR2ZILEVBQVMsS0FBTWQsU0FBU0UsWUFBYWMsR0FGckNGLFFBQWVGLGFBQXFCLEtBQU0sVUFXdERULHFCQUFxQlMsRUFBVVcsRUFBSVYsRUFBV0MsR0FDNUMsTUFBTVYs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QyxPQUFPN0csS0FBSyxTQUFTNkcsR0FDWCxXQUFWQSxHQUNKTixFQUFPTyxZQUFZLENBQUNDLE9BQVEiLCJmaWxlIjoiZGJoZWxwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29tbW9uIGRhdGFiYXNlIGhlbHBlciBmdW5jdGlvbnMuXHJcbiAqL1xyXG5jbGFzcyBEQkhlbHBlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIERhdGFiYXNlIFVSTC5cclxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgc3RhdGljIGdldCBEQVRBQkFTRV9VUkwoKSB7XHJcbiAgICAvL2NvbnN0IHBvcnQgPSAxMzM3IC8vIENoYW5nZSB0aGlzIHRvIHlvdXIgc2VydmVyIHBvcnRcclxuICAgIHJldHVybiBgaHR0cHM6Ly9hcGktcmVzdGF1cmFudC1yZXZpZXdzLmhlcm9rdWFwcC5jb21gO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldCBvZmZFcnJvck1zZygpIHtcclxuICAgIHJldHVybiAnTmV0d29yayByZXF1ZXN0cyBoYXZlIGZhaWxlZCwgdGhpcyBpcyBleHBlY3RlZCBpZiBvZmZsaW5lJztcclxuICB9XHJcblxyXG4gIC8qIE5ldHdvcmsgZnVuY3Rpb25zICovXHJcblxyXG4gIHN0YXRpYyBnZXRTZXJ2ZXJEYXRhKHVybCkge1xyXG4gICAgcmV0dXJuIGZldGNoKHVybCkudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcclxuICAgICAgICB0aHJvdyBFcnJvcihyZXNwb25zZS5zdGF0dXNUZXh0KTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgcmVxdWVzdGVkIGRhdGEuXHJcbiAgICogVXNpbmcgRmV0Y2ggQVBJLlxyXG4gICAqIEBwYXJhbSBkYXRhTmFtZSBuYW1lIG9mIHRoZSByZXF1ZXN0ZWQgZGF0YVxyXG4gICAqIEBwYXJhbSBjYWxsYmFjayB0aGUgY2FsbGJhY2sgZnVuY3Rpb25cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hEYXRhKGRhdGFOYW1lLCBkYlByb21pc2UsIGNhbGxiYWNrKSB7XHJcblxyXG4gICAgY29uc3QgdXJsID0gYCR7REJIZWxwZXIuREFUQUJBU0VfVVJMfS8ke2RhdGFOYW1lfS9gO1xyXG5cclxuICAgIERCSGVscGVyLmdldExvY2FsRGF0YShkYlByb21pc2UsIGRhdGFOYW1lKVxyXG4gICAgICAudGhlbihvZmZsaW5lRGF0YSA9PiB7XHJcbiAgICAgICAgaWYgKG9mZmxpbmVEYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgbnVsbCwgb2ZmbGluZURhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBEQkhlbHBlci5nZXRTZXJ2ZXJEYXRhKHVybClcclxuICAgICAgICAgIC50aGVuKGRhdGFGcm9tTmV0d29yayA9PiB7XHJcbiAgICAgICAgICAgIERCSGVscGVyLl91cGRhdGVEQihkYXRhTmFtZSwgZGF0YUZyb21OZXR3b3JrKTtcclxuICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgbnVsbCwgZGF0YUZyb21OZXR3b3JrKTtcclxuICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgIGlmICghb2ZmbGluZURhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2soYE5vICR7ZGF0YU5hbWV9IGZvdW5kIDooYCwgbnVsbCwgbnVsbCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgREJIZWxwZXIub2ZmRXJyb3JNc2csIG9mZmxpbmVEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSlcclxuICAgICAgfSlcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGEgZGF0YSBieSBpdHMgSUQuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoRGF0YUJ5SWQoZGF0YU5hbWUsIGlkLCBkYlByb21pc2UsIGNhbGxiYWNrKSB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9LyR7ZGF0YU5hbWV9LyR7aWR9YDtcclxuXHJcbiAgICBEQkhlbHBlci5nZXRMb2NhbERhdGEoZGJQcm9taXNlLCBkYXRhTmFtZSwgaWQsIGZhbHNlKVxyXG4gICAgICAudGhlbihvZmZsaW5lRGF0YSA9PiB7XHJcbiAgICAgICAgaWYgKG9mZmxpbmVEYXRhKSB7XHJcbiAgICAgICAgICBjYWxsYmFjayhudWxsLCBudWxsLCBvZmZsaW5lRGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIERCSGVscGVyLmdldFNlcnZlckRhdGEodXJsKVxyXG4gICAgICAgICAgLnRoZW4oZGF0YUZyb21OZXR3b3JrID0+IHtcclxuICAgICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZURCKGRhdGFOYW1lLCBkYXRhRnJvbU5ldHdvcmspO1xyXG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBudWxsLCBkYXRhRnJvbU5ldHdvcmspO1xyXG4gICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgaWYgKCFvZmZsaW5lRGF0YSkge1xyXG4gICAgICAgICAgICAgIGNhbGxiYWNrKGBObyAke2RhdGFOYW1lfSBmb3VuZCA6KGAsIG51bGwsIG51bGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIERCSGVscGVyLm9mZkVycm9yTXNnLCBvZmZsaW5lRGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgIH0pXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgcmVxdWVzdGVkIGRhdGEuXHJcbiAgICogVXNpbmcgRmV0Y2ggQVBJLlxyXG4gICAqIEBwYXJhbSBpZCByZXN0YXVyYW50IGlkXHJcbiAgICogQHBhcmFtIGNhbGxiYWNrIHRoZSBjYWxsYmFjayBmdW5jdGlvblxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJldmlld3NCeVJlc3RhdXJhbnRJZChpZCwgZGJQcm9taXNlLCBjYWxsYmFjaykge1xyXG4gICAgY29uc3QgZGF0YU5hbWUgPSAncmV2aWV3cyc7XHJcbiAgICBjb25zdCB1cmwgPSBgJHtEQkhlbHBlci5EQVRBQkFTRV9VUkx9LyR7ZGF0YU5hbWV9Lz9yZXN0YXVyYW50X2lkPSR7aWR9YDtcclxuXHJcbiAgICBEQkhlbHBlci5nZXRMb2NhbERhdGEoZGJQcm9taXNlLCBkYXRhTmFtZSwgaWQsIHRydWUsICdieS1yZXN0YXVyYW50JylcclxuICAgICAgLnRoZW4ob2ZmbGluZURhdGEgPT4ge1xyXG4gICAgICAgIGlmIChvZmZsaW5lRGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgIG9mZmxpbmVEYXRhLnJldmVyc2UoKTtcclxuICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bGwsIG9mZmxpbmVEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgREJIZWxwZXIuZ2V0U2VydmVyRGF0YSh1cmwpXHJcbiAgICAgICAgICAudGhlbihkYXRhRnJvbU5ldHdvcmsgPT4ge1xyXG4gICAgICAgICAgICBEQkhlbHBlci5fdXBkYXRlREIoZGF0YU5hbWUsIGRhdGFGcm9tTmV0d29yayk7XHJcbiAgICAgICAgICAgIGRhdGFGcm9tTmV0d29yay5yZXZlcnNlKCk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG51bGwsIGRhdGFGcm9tTmV0d29yayk7XHJcbiAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIW9mZmxpbmVEYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgIGNhbGxiYWNrKGBObyAke2RhdGFOYW1lfSBmb3VuZCA6KGAsIG51bGwsIG51bGwpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIERCSGVscGVyLm9mZkVycm9yTXNnLCBvZmZsaW5lRGF0YSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pXHJcbiAgICAgIH0pXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgdHlwZSB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hSZXN0YXVyYW50QnlDdWlzaW5lKGN1aXNpbmUsIGRiUHJvbWlzZSwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50cyAgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmdcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCAoZXJyb3IsIG1zZywgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gY3Vpc2luZSB0eXBlXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIuY3Vpc2luZV90eXBlID09IGN1aXNpbmUpO1xyXG4gICAgICAgIGNhbGxiYWNrKG1zZywgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5TmVpZ2hib3Job29kKG5laWdoYm9yaG9vZCwgZGJQcm9taXNlLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgZGJQcm9taXNlLCAoZXJyb3IsIG1zZywgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEZpbHRlciByZXN0YXVyYW50cyB0byBoYXZlIG9ubHkgZ2l2ZW4gbmVpZ2hib3Job29kXHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHJlc3RhdXJhbnRzLmZpbHRlcihyID0+IHIubmVpZ2hib3Job29kID09IG5laWdoYm9yaG9vZCk7XHJcbiAgICAgICAgY2FsbGJhY2sobXNnLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXN0YXVyYW50cyBieSBhIGN1aXNpbmUgYW5kIGEgbmVpZ2hib3Job29kIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmVBbmROZWlnaGJvcmhvb2QoY3Vpc2luZSwgbmVpZ2hib3Job29kLCBkYlByb21pc2UsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoRGF0YSgncmVzdGF1cmFudHMnLCBkYlByb21pc2UsIChlcnJvciwgbXNnLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbGV0IHJlc3VsdHMgPSByZXN0YXVyYW50c1xyXG4gICAgICAgIGlmIChjdWlzaW5lICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBjdWlzaW5lXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5laWdoYm9yaG9vZCAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgbmVpZ2hib3Job29kXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYWxsYmFjayhtc2csIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCBuZWlnaGJvcmhvb2RzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaE5laWdoYm9yaG9vZHMoZGJQcm9taXNlLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaERhdGEoJ3Jlc3RhdXJhbnRzJywgZGJQcm9taXNlLCAoZXJyb3IsIG1zZywgcmVzdGF1cmFudHMpID0+IHtcclxuICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIEdldCBhbGwgbmVpZ2hib3Job29kcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IG5laWdoYm9yaG9vZHMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLm5laWdoYm9yaG9vZClcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIG5laWdoYm9yaG9vZHNcclxuICAgICAgICBjb25zdCB1bmlxdWVOZWlnaGJvcmhvb2RzID0gbmVpZ2hib3Job29kcy5maWx0ZXIoKHYsIGkpID0+IG5laWdoYm9yaG9vZHMuaW5kZXhPZih2KSA9PSBpKVxyXG4gICAgICAgIGNhbGxiYWNrKG1zZywgdW5pcXVlTmVpZ2hib3Job29kcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIGN1aXNpbmVzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaEN1aXNpbmVzKGRiUHJvbWlzZSwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hEYXRhKCdyZXN0YXVyYW50cycsIGRiUHJvbWlzZSwgKGVycm9yLCBtc2csIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBHZXQgYWxsIGN1aXNpbmVzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcbiAgICAgICAgY29uc3QgY3Vpc2luZXMgPSByZXN0YXVyYW50cy5tYXAoKHYsIGkpID0+IHJlc3RhdXJhbnRzW2ldLmN1aXNpbmVfdHlwZSlcclxuICAgICAgICAvLyBSZW1vdmUgZHVwbGljYXRlcyBmcm9tIGN1aXNpbmVzXHJcbiAgICAgICAgY29uc3QgdW5pcXVlQ3Vpc2luZXMgPSBjdWlzaW5lcy5maWx0ZXIoKHYsIGkpID0+IGN1aXNpbmVzLmluZGV4T2YodikgPT0gaSlcclxuICAgICAgICBjYWxsYmFjayhtc2csIHVuaXF1ZUN1aXNpbmVzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IHBhZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyB1cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYC4vcmVzdGF1cmFudC5odG1sP2lkPSR7cmVzdGF1cmFudC5pZH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2UgZGVzY3JpcHRpb24uXHJcbiAgICovXHJcbiAgc3RhdGljIGdldFBob3RvRGVzY3JpcHRpb24ocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgUGhvdG8gb2YgJHtyZXN0YXVyYW50Lm5hbWV9IGluICR7cmVzdGF1cmFudC5uZWlnaGJvcmhvb2R9YCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IGltYWdlIFVSTC5cclxuICAgKi9cclxuICBzdGF0aWMgaW1hZ2VVcmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQsIGxvdyA9IGZhbHNlKSB7XHJcbiAgICBpZiAocmVzdGF1cmFudCAmJiByZXN0YXVyYW50LnBob3RvZ3JhcGgpIHtcclxuICAgICAgcmV0dXJuIChsb3cpID8gKGBpbWdzLyR7cmVzdGF1cmFudC5waG90b2dyYXBofS1sb3cuanBnYCkgOlxyXG4gICAgICAgICAgICAgICAgICAgIChgaW1ncy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaH0uanBnYCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gKGBpbWdzL25vLXBpY3R1cmVzLnN2Z2ApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVzdGF1cmFudCBpbWFnZSBzcmNzZXQgVVJMcy5cclxuICAgKi9cclxuICBzdGF0aWMgaW1hZ2VTUkNTZXRVcmxzRm9yUmVzdGF1cmFudChyZXN0YXVyYW50LCBvcHRzKSB7XHJcbiAgICBsZXQgaW1hZ2VzID0gW107XHJcblxyXG4gICAgaWYgKHJlc3RhdXJhbnQgJiYgcmVzdGF1cmFudC5waG90b2dyYXBoKSB7XHJcbiAgICAgIG9wdHMuZm9yRWFjaChwcm9wID0+IHtcclxuICAgICAgICBpbWFnZXMucHVzaChgaW1ncy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaH0tJHtwcm9wfS5qcGcgJHtwcm9wfWApO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gaW1hZ2VzLmpvaW4oJywgJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNYXAgbWFya2VyIGZvciBhIHJlc3RhdXJhbnQuXHJcbiAgICovXHJcbiAgc3RhdGljIG1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbWFwKSB7XHJcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgcG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxyXG4gICAgICB0aXRsZTogcmVzdGF1cmFudC5uYW1lLFxyXG4gICAgICB1cmw6IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCksXHJcbiAgICAgIG1hcDogbWFwLFxyXG4gICAgICBhbmltYXRpb246IGdvb2dsZS5tYXBzLkFuaW1hdGlvbi5EUk9QfVxyXG4gICAgKTtcclxuICAgIHJldHVybiBtYXJrZXI7XHJcbiAgfVxyXG5cclxuICAvKiBTdG9yYWdlIGZ1bmN0aW9ucyAqL1xyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGUgZGF0YWJhc2UgZm9yIHJlc3RhdXJhbnRzLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBvcGVuRGF0YWJhc2UoKSB7XHJcbiAgICAvLyBJZiB0aGUgYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgc2VydmljZSB3b3JrZXIsXHJcbiAgICAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGhhdmluZyBhIGRhdGFiYXNlXHJcbiAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSB7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoISgnaW5kZXhlZERCJyBpbiB3aW5kb3cpKSB7cmV0dXJuIG51bGw7fVxyXG5cclxuICAgIHJldHVybiBpZGIub3BlbigncmVzdGF1cmFudHNEYXRhJywgMSwgZnVuY3Rpb24odXBncmFkZURiKSB7XHJcbiAgICAgIGNvbnN0IHN0b3JlcyA9IFsncmVzdGF1cmFudHMnLCAncmV2aWV3cycsICduZXdSJywgJ25ld0lzRmF2b3VyaXRlJ107XHJcbiAgICAgIHN0b3Jlcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIGlmICghdXBncmFkZURiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoaXRlbSkpIHtcclxuICAgICAgICAgIGxldCBzdG9yZSA9IHVwZ3JhZGVEYi5jcmVhdGVPYmplY3RTdG9yZShpdGVtLCB7XHJcbiAgICAgICAgICAgIGF1dG9JbmNyZW1lbnQgOiB0cnVlLCBrZXlQYXRoOiAnaWQnXHJcbiAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICBzdG9yZS5jcmVhdGVJbmRleCgnYnktZGF0ZScsICdjcmVhdGVkQXQnKTtcclxuXHJcbiAgICAgICAgICBpZiAoaXRlbSA9PT0gJ3Jldmlld3MnIHx8IGl0ZW0gPT09ICduZXdJc0Zhdm91cml0ZScpIHtcclxuICAgICAgICAgICAgc3RvcmUuY3JlYXRlSW5kZXgoJ2J5LXJlc3RhdXJhbnQnLCAncmVzdGF1cmFudF9pZCcpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIG5ldyByZXN0YXVyYW50cyBmcm9tIG5ldHdvcmsuXHJcbiAgICovXHJcbiAgc3RhdGljIF91cGRhdGVEQihkYXRhTmFtZSwgZGF0YSwgY2FsbGJhY2spIHtcclxuICAgIHJldHVybiBEQkhlbHBlci5vcGVuRGF0YWJhc2UoKS50aGVuKGZ1bmN0aW9uKGRiKSB7XHJcbiAgICAgIGlmICghZGIpIHJldHVybjtcclxuXHJcbiAgICAgIHZhciB0eCA9IGRiLnRyYW5zYWN0aW9uKGRhdGFOYW1lLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgIHZhciBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKGRhdGFOYW1lKTtcclxuXHJcbiAgICAgIGxldCBuZXdEYXRhID0gW10uY29uY2F0KGRhdGEpO1xyXG5cclxuICAgICAgbmV3RGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIHN0b3JlLnB1dChpdGVtKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBsaW1pdCBzdG9yZSB0byAzMCBpdGVtc1xyXG4gICAgICBzdG9yZS5pbmRleCgnYnktZGF0ZScpLm9wZW5DdXJzb3IobnVsbCwgXCJwcmV2XCIpLnRoZW4oZnVuY3Rpb24oY3Vyc29yKSB7XHJcbiAgICAgICAgcmV0dXJuIGN1cnNvci5hZHZhbmNlKDMwKTtcclxuICAgICAgfSkudGhlbihmdW5jdGlvbiBkZWxldGVSZXN0KGN1cnNvcikge1xyXG4gICAgICAgIGlmICghY3Vyc29yKSByZXR1cm47XHJcbiAgICAgICAgY3Vyc29yLmRlbGV0ZSgpO1xyXG4gICAgICAgIHJldHVybiBjdXJzb3IuY29udGludWUoKS50aGVuKGRlbGV0ZVJlc3QpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldExvY2FsRGF0YShkYlByb21pc2UsIGRhdGFOYW1lLCBpZCwgZ2V0QWxsID0gdHJ1ZSwgaW5kZXgpIHtcclxuICAgIGlmICghKCdpbmRleGVkREInIGluIHdpbmRvdykpIHtyZXR1cm4gbnVsbDt9XHJcbiAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICBpZighaXNOYU4oaWQpKSB7XHJcbiAgICAgICAgaWQgPSBwYXJzZUludChpZCk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgdHggPSBkYi50cmFuc2FjdGlvbihkYXRhTmFtZSwgJ3JlYWRvbmx5Jyk7XHJcbiAgICAgIGNvbnN0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoZGF0YU5hbWUpO1xyXG4gICAgICBjb25zdCBkYkluZGV4ID0gKGluZGV4KSA/IHN0b3JlLmluZGV4KGluZGV4KSA6IHN0b3JlO1xyXG4gICAgICBpZiAoZ2V0QWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIChpZCkgPyBkYkluZGV4LmdldEFsbChpZCkgOiBkYkluZGV4LmdldEFsbCgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBkYkluZGV4LmdldChpZCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVnaXN0ZXIgc2VydmljZSB3b3JrZXJcclxuICAgKi9cclxuICAgc3RhdGljIHJlZ2lzdGVyU2VydmljZVdvcmtlcigpIHtcclxuICAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSB7XHJcbiAgICAgICByZXR1cm47XHJcbiAgICAgfVxyXG5cclxuICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3Rlcignc3cuanMnKS50aGVuKGZ1bmN0aW9uKHJlZykge1xyXG4gICAgICAgaWYgKCFuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyKSB7XHJcbiAgICAgICAgIHJldHVybjtcclxuICAgICAgIH1cclxuXHJcbiAgICAgICBpZiAocmVnLndhaXRpbmcpIHtcclxuICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZVJlYWR5KHJlZy53YWl0aW5nKTtcclxuICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgfVxyXG5cclxuICAgICAgIGlmIChyZWcuaW5zdGFsbGluZykge1xyXG4gICAgICAgICBEQkhlbHBlci5fdHJhY2tJbnN0YWxsaW5nKHJlZy5pbnN0YWxsaW5nKTtcclxuICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgfVxyXG5cclxuICAgICAgIHJlZy5hZGRFdmVudExpc3RlbmVyKCd1cGRhdGVmb3VuZCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICBEQkhlbHBlci5fdHJhY2tJbnN0YWxsaW5nKHJlZy5pbnN0YWxsaW5nKTtcclxuICAgICAgIH0pO1xyXG4gICAgIH0pO1xyXG5cclxuICAgICAvLyBFbnN1cmUgcmVmcmVzaCBpcyBvbmx5IGNhbGxlZCBvbmNlLlxyXG4gICAgIC8vIFRoaXMgd29ya3MgYXJvdW5kIGEgYnVnIGluIFwiZm9yY2UgdXBkYXRlIG9uIHJlbG9hZFwiLlxyXG4gICAgIHZhciByZWZyZXNoaW5nO1xyXG4gICAgIG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRyb2xsZXJjaGFuZ2UnLCBmdW5jdGlvbigpIHtcclxuICAgICAgIGlmIChyZWZyZXNoaW5nKSByZXR1cm47XHJcbiAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XHJcbiAgICAgICByZWZyZXNoaW5nID0gdHJ1ZTtcclxuICAgICB9KTtcclxuICAgfVxyXG5cclxuICAgLyoqXHJcbiAgICAqIHNlcnZpY2Ugd29ya2VyXHJcbiAgICAqL1xyXG4gICBzdGF0aWMgX3RyYWNrSW5zdGFsbGluZyh3b3JrZXIpIHtcclxuICAgICB3b3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignc3RhdGVjaGFuZ2UnLCBmdW5jdGlvbigpIHtcclxuICAgICAgIGlmICh3b3JrZXIuc3RhdGUgPT0gJ2luc3RhbGxlZCcpIHtcclxuICAgICAgICAgREJIZWxwZXIuX3VwZGF0ZVJlYWR5KHdvcmtlcik7XHJcbiAgICAgICB9XHJcbiAgICAgfSk7XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICAgKiBzZXJ2aWNlIHdvcmtlclxyXG4gICAgKi9cclxuICAgc3RhdGljIF91cGRhdGVSZWFkeSh3b3JrZXIpIHtcclxuICAgICB0aGlzLl90b2FzdHNWaWV3ID0gbmV3IFRvYXN0KCk7XHJcbiAgICAgY29uc3QgdG9hc3QgPSB0aGlzLl90b2FzdHNWaWV3LmNyZWF0ZShcIk5ldyB2ZXJzaW9uIGF2YWlsYWJsZVwiLCBudWxsLCBbJ3JlZnJlc2gnLCAnZGlzbWlzcyddKTtcclxuXHJcbiAgICAgdG9hc3QuYW5zd2VyLnRoZW4oZnVuY3Rpb24oYW5zd2VyKSB7XHJcbiAgICAgICBpZiAoYW5zd2VyICE9ICdyZWZyZXNoJykgcmV0dXJuO1xyXG4gICAgICAgd29ya2VyLnBvc3RNZXNzYWdlKHthY3Rpb246ICdza2lwV2FpdGluZyd9KTtcclxuICAgICB9KTtcclxuICAgfVxyXG5cclxufVxyXG4iXX0=
